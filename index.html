<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Control de Calidad - GAS Paint & Detail</title>

    <link rel="icon" type="image/jpeg" href="assets/logo2.JPG">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

    <style>
        /* --- VARIABLES DE COLOR --- */
        :root {
            --primary-dark: #202D3F; 
            --container-bg: #2c3e50; 
            --primary-blue: #007bff; 
            --text-light: #ecf0f1; 
            --text-muted: #bdc3c7; 
            --success: #27ae60; 
            --border-dark: #495a6b; 
            --input-bg: #34495e; 
            --error: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary-dark);
            margin: 0; padding: 20px; color: var(--text-light);
            animation: fadePageIn 0.6s ease-out forwards;
        }
        .container {
            max-width: 850px; margin: 0 auto; background: var(--container-bg);
            padding: 30px; border-radius: 8px; box-shadow: 0 8px 15px rgba(0,0,0,0.4);
        }

        /* LOGOS */
        .logo-container { text-align: center; margin-bottom: 20px; }
        .logo-screen { max-width: 250px; height: auto; display: block; margin: 0 auto; }
        .logo-print, #print-date-display { display: none; }

        h1 {
            text-align: center; color: var(--text-light); border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 10px; margin-top: 20px;
        }
        
        /* FORMULARIOS */
        .form-group { display: flex; flex-direction: column; margin-bottom: 10px; }
        .form-group label { font-weight: bold; margin-bottom: 5px; font-size: 0.9em; color: var(--text-muted); }

        input[type="text"], input[type="number"], select, input[type="date"], input[type="time"], textarea {
            padding: 10px; border: 1px solid var(--border-dark); border-radius: 4px; 
            font-size: 14px; background-color: var(--input-bg); color: var(--text-light);
            font-family: inherit; line-height: 1.5;
        }
        @media (max-width: 900px), (max-height: 700px) {
            input[type="text"], input[type="number"], select, input[type="date"], input[type="time"], textarea {
                min-height: 44px; padding: 12px; font-size: 16px; line-height: 1.6;
            }
        }
        .uppercase-input { text-transform: uppercase; } 
        textarea { resize: vertical; min-height: 60px; } 
        select option { background: var(--input-bg); color: var(--text-light); }

        .header-info {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; margin-bottom: 20px; background: var(--input-bg);
            padding: 15px; border-radius: 5px; border: 1px solid var(--border-dark);
        }
        .header-info label { color: var(--text-light) !important; font-weight: 600; }

        /* SECCIONES */
        .section {
            border: 1px solid var(--border-dark); border-radius: 8px; margin-bottom: 25px; 
            overflow: hidden; background: var(--input-bg); transition: all 0.3s; position: relative;
        }
        .section::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background: var(--border-dark); transition: background 0.3s ease;
        }
        .section:hover { box-shadow: 0 8px 24px rgba(0, 123, 255, 0.2); border-color: var(--primary-blue); transform: translateY(-2px); }
        .section:hover::before { background: var(--primary-blue); }
        .section.active-section { box-shadow: 0 0 15px 3px rgba(0, 123, 255, 0.6); border-color: var(--primary-blue); }
        .section.active-section::before { background: var(--success); }

        .section-progress-bar { height: 3px; background: var(--border-dark); margin-top: 10px; border-radius: 2px; overflow: hidden; }
        .section-progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary-blue) 0%, var(--success) 100%); width: 0%; transition: width 0.3s ease; }

        .section-header {
            background: linear-gradient(90deg, var(--primary-dark) 0%, rgba(0, 123, 255, 0.05) 100%);
            color: var(--text-light); padding: 16px 15px; font-weight: 700; 
            display: flex; justify-content: space-between; align-items: center; font-size: 1.1em;
        }
        .status-indicator { background: var(--border-dark); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; transition: background 0.3s; }
        .section-header.completed { background-color: var(--success) !important; color: white !important; border-bottom: 1px solid var(--success); }
        .section-header.completed .status-indicator { background: white !important; color: var(--success) !important; }

        /* ADMIN & ERRORES */
        .admin-row { padding: 15px; border-bottom: 1px solid var(--border-dark); background-color: var(--input-bg); }
        .admin-question { font-weight: 600; color: var(--text-light); margin-bottom: 10px; display: block; }
        .input-cluster { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .sub-note { font-size: 0.85em; color: var(--text-muted); margin-top: 5px; font-style: italic; }
        .highlight-box { padding: 10px; border-radius: 4px; margin-top: 10px; border: 1px solid; }
        #devolucion-block { background-color: #5d4037; border-color: #8d6e63; color: var(--text-light); }
        #corregido-block { background-color: #004d40; border-color: #26a69a; color: var(--text-light); }
        #devolucion-block .sub-note, #corregido-block .sub-note { color: var(--text-light); }
        .input-invalid { border-color: var(--error) !important; box-shadow: 0 0 8px rgba(231,76,60,0.25); }
        .error-text { color: var(--error); font-size: 0.85em; margin-top: 6px; display: none; }
        .error-text.visible { display: block; }

        /* FLATPICKR */
        .flatpickr-input, input.flatpickr-input, .flatpickr-alt-input { background-color: var(--input-bg) !important; color: var(--text-light) !important; border: 1px solid var(--border-dark) !important; padding: 10px !important; border-radius: 4px !important; }
        .flatpickr-calendar { background: var(--input-bg) !important; border: 1px solid var(--border-dark) !important; box-shadow: 0 8px 20px rgba(0,0,0,0.5) !important; }
        .flatpickr-months, .flatpickr-weekdays { background: var(--primary-dark) !important; }
        .flatpickr-day { color: var(--text-light) !important; }
        .flatpickr-day.selected { background: var(--primary-blue) !important; border-color: var(--primary-blue) !important; color: white !important; }
        
        /* Iconos Flatpickr Mobile */
        .flat-date, .flat-date + input { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23bdc3c7' viewBox='0 0 24 24'%3E%3Cpath d='M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z'/%3E%3C/svg%3E") !important; background-repeat: no-repeat !important; background-position: right 15px center !important; background-size: 20px !important; padding-right: 35px !important; }
        .flat-time, .flat-time + input { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23bdc3c7' viewBox='0 0 24 24'%3E%3Cpath d='M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z'/%3E%3C/svg%3E") !important; background-repeat: no-repeat !important; background-position: right 15px center !important; background-size: 20px !important; padding-right: 35px !important; }
        ::placeholder { color: #bdc3c7 !important; opacity: 1 !important; }
        @media (max-width: 600px) { .input-cluster { flex-direction: row; flex-wrap: wrap; } .input-cluster input { min-width: 130px !important; flex-grow: 1; } }

        /* OBSERVACIONES */
        .obs-area { padding: 15px; border-top: 1px dashed var(--border-dark); background-color: rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .obs-area textarea { width: 100%; box-sizing: border-box; }

        /* --- NUEVO CSS: CHECKLIST DE DOBLE OPCI√ìN --- */
        .checklist { padding: 10px 18px; }
        
        .check-item {
            display: flex;
            flex-direction: column; /* Columna para que la caja de texto baje */
            padding: 12px 0;
            border-bottom: 1px solid var(--border-dark); 
            transition: 0.25s ease;
        }
        .check-item:last-child { border-bottom: none; }
        .check-item:hover { transform: translateX(5px); background: rgba(255, 255, 255, 0.05); }

        /* Wrapper para la fila de checkboxes y label */
        .check-row-wrapper { display: flex; align-items: center; width: 100%; }

        /* Estilo base checkboxes (para todos, incluyendo admin) */
        .check-item input[type="checkbox"] {
            width: 22px; height: 22px; min-width: 22px;
            border: 2px solid var(--border-dark); border-radius: 6px; margin-right: 10px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            background-color: var(--input-bg); appearance: none; -webkit-appearance: none;
            transition: all 0.2s;
        }

        /* CHECKBOX VERDE (OK) */
        .check-pass:hover { border-color: var(--success); box-shadow: 0 0 8px rgba(39, 174, 96, 0.4); }
        .check-pass:checked {
            background: linear-gradient(135deg, var(--success) 0%, #1e8449 100%);
            border-color: var(--success); box-shadow: 0 0 12px rgba(39, 174, 96, 0.6);
            animation: pulseCheck .3s ease-out;
        }
        .check-pass:checked::after { content: "‚úî"; color: white; font-size: 14px; font-weight: bold; }

        /* CHECKBOX ROJO (FAIL) */
        .check-fail { border-color: #7f8c8d !important; margin-right: 15px !important; }
        .check-fail:hover { border-color: var(--error) !important; box-shadow: 0 0 8px rgba(231, 76, 60, 0.4); }
        .check-fail:checked {
            background: linear-gradient(135deg, var(--error) 0%, #c0392b 100%);
            border-color: var(--error) !important; box-shadow: 0 0 12px rgba(231, 76, 60, 0.6);
            animation: pulseCheck .3s ease-out;
        }
        .check-fail:checked::after { content: "‚úñ"; color: white; font-size: 14px; font-weight: bold; }

        .check-row-wrapper label { color: var(--text-light); cursor: pointer; flex: 1; }

        /* CAJA DE OBSERVACI√ìN ESPEC√çFICA (Oculta por defecto) */
        .specific-obs {
            display: none; width: 100%; margin-top: 8px; padding-left: 65px; 
            box-sizing: border-box; animation: slideDown 0.2s ease-out;
        }
        .specific-obs.visible { display: block; }
        .specific-obs input {
            width: 95%; padding: 8px; border: 1px solid var(--error);
            background-color: rgba(231, 76, 60, 0.1); color: #ffcccc; font-size: 0.9em;
        }
        .specific-obs input::placeholder { color: #e59898; }

        @keyframes pulseCheck { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* BOTONES & UI */
        .button-group { display: flex; gap: 10px; margin-top: 30px; }
        .btn-submit, .btn-clear { flex-grow: 1; padding: 15px; border: none; border-radius: 6px; font-size: 1.1em; font-weight: 600; cursor: pointer; color: white; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-submit { background: linear-gradient(135deg, var(--primary-blue) 0%, #0056b3 100%); box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3); }
        .btn-clear { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3); }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 123, 255, 0.5); }
        .btn-clear:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(231, 76, 60, 0.5); }
        .btn-submit::before { content: 'üñ®Ô∏è'; font-size: 1.2em; } .btn-clear::before { content: 'üóëÔ∏è'; font-size: 1.2em; }
        .btn-submit[disabled] { opacity: 0.6; cursor: not-allowed; box-shadow: none; }

        /* INDICADOR GUARDADO */
        #save-indicator { position: fixed; top: 20px; right: 20px; background-color: var(--success); color: white; padding: 8px 15px; border-radius: 5px; opacity: 0; transition: opacity 0.5s; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 1000; }

        /* TOASTS (MANTENIDOS INTACTOS) */
        .toast-container { position: fixed; right: 20px; bottom: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; pointer-events: none; }
        .toast { pointer-events: auto; display:flex; align-items:flex-start; gap:10px; padding: 12px 14px; border-radius: 10px; background: rgba(0,0,0,0.88); color: #fff; box-shadow: 0 6px 20px rgba(0,0,0,0.45); min-width: 240px; max-width: 420px; transform: translateY(10px); animation: toastIn .35s ease forwards; }
        .toast.success { border-left: 6px solid #2ecc71; } .toast.error { border-left: 6px solid #e74c3c; } .toast.info { border-left: 6px solid #3498db; } .toast.warning { border-left: 6px solid #f1c40f; }
        .toast .icon { font-size: 18px; line-height: 1; margin-top: 2px; }
        .toast .content { display: flex; flex-direction: column; }
        .toast .title { font-weight: 700; margin-bottom: 4px; }
        .toast .message { white-space: pre-line; font-size: 0.95rem; color: #f5f7f9; }
        .toast .close { background: transparent; border: none; color: inherit; font-size: 16px; cursor: pointer; margin-left: 8px; padding: 4px; border-radius: 6px; }
        .toast-actions { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
        .toast-action-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(15px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes toastOut { from { opacity: 1; transform: translateX(0) translateY(0) scale(1); } to { opacity: 0; transform: translateX(120%) translateY(-5px) scale(0.95); } }
        @keyframes toastPulse { 0% { transform: scale(1); } 50% { transform: scale(1.04); } 100% { transform: scale(1); } }
        @media (max-width: 900px), (max-height: 700px) { .toast-container { left: 50% !important; right: auto !important; bottom: auto !important; top: env(safe-area-inset-top,20px); transform: translateX(-50%); align-items: center; } .toast { width: calc(100% - 40px); max-width: calc(100% - 40px); } }
        @media print { .toast-container { display: none !important; } }

        /* MODALES */
        .modal-overlay { position: fixed; inset: 0; background: rgba(2,6,23,0.6); display: flex; align-items: center; justify-content: center; z-index: 20000; }
        .confirm-dialog { background: var(--container-bg); color: var(--text-light); padding: 20px; border-radius: 10px; width: 92%; max-width: 520px; box-shadow: 0 12px 30px rgba(0,0,0,0.6); border: 1px solid var(--border-dark); animation: modalIn .22s cubic-bezier(.2,.9,.2,1) both; }
        .confirm-dialog .cd-title { font-size: 1.05rem; font-weight: 800; margin-bottom: 8px; }
        .confirm-dialog .cd-message { color: var(--text-muted); margin-bottom: 16px; }
        .confirm-dialog .cd-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .confirm-dialog .btn-cancel { background: transparent; border: 1px solid var(--border-dark); color: var(--text-light); padding: 10px 14px; border-radius: 6px; cursor: pointer; }
        .confirm-dialog .btn-confirm { background: var(--error); color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; }
        .history-modal { background: var(--container-bg); color: var(--text-light); padding: 20px; border-radius: 10px; width: 92%; max-width: 520px; box-shadow: 0 12px 30px rgba(0,0,0,0.6); border: 1px solid var(--border-dark); animation: modalIn .22s cubic-bezier(.2,.9,.2,1) both; }
        .history-modal .hm-list li { padding: 10px; margin-bottom: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .history-modal .hm-restore { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .history-modal .btn-close-history { background: transparent; border: 1px solid var(--border-dark); color: var(--text-light); padding: 10px 14px; border-radius: 6px; cursor: pointer; }
        @keyframes modalIn { from { opacity: 0; transform: translateY(8px) scale(.995); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* FOOTER & FIRMA */
        .footer-info { text-align: center; margin-top: 40px; padding: 20px 15px; border-top: 2px solid var(--border-dark); font-size: 0.85em; color: var(--text-muted); background: linear-gradient(180deg, transparent 0%, rgba(0, 123, 255, 0.03) 100%); border-radius: 8px; }
        .hover-underline { font-size: 1em; color: var(--text-muted); position: relative; display: inline-block; cursor: default; }
        .hover-underline::after { content: ''; position: absolute; width: 100%; height: 1px; background: linear-gradient(to right, var(--primary-blue), var(--success)); bottom: -3px; left: 0; transform: scaleX(0); transform-origin: right; transition: transform 0.4s ease-out; }
        .hover-underline:hover { color: var(--text-light); } .hover-underline:hover::after { transform: scaleX(1); }

        .signature-pad-wrapper { background-color: var(--input-bg); border: 1px solid var(--border-dark); border-radius: 8px; padding: 10px; margin-top: 20px; display: flex; flex-direction: column; align-items: center; }
        .signature-pad-body { position: relative; width: 100%; max-width: 600px; height: 200px; background-color: #fff; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); touch-action: none; }
        canvas#signature-pad { width: 100%; height: 100%; display: block; }
        .signature-actions { margin-top: 10px; width: 100%; max-width: 600px; display: flex; justify-content: flex-end; }
        .btn-small { padding: 5px 10px; font-size: 0.9em; background-color: var(--border-dark); color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-small:hover { background-color: var(--error); }
        .signature-label { color: #000; position: absolute; bottom: 5px; left: 10px; font-size: 0.8em; pointer-events: none; opacity: 0.5; }

        /* --- MEDIA PRINT (MODIFICADO PARA SOPORTAR DOBLE CHECK) --- */
        @media print {
            @page { margin: 1cm; size: auto; }
            .print-hidden-icon, #save-indicator, .button-group, h1, .footer-info, .section-index, .toast-container, .signature-actions { display: none !important; }
            
            body, .container, .section, .header-info, input, select, textarea, label, span, div, p { background: #fff !important; color: #000 !important; box-shadow: none !important; text-shadow: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body { padding: 0; font-size: 11pt; font-family: Arial, Helvetica, sans-serif; }
            .container { max-width: 100%; margin: 0; padding: 0 5px; border: none !important; }

            /* INPUTS PLANOS */
            input[type="text"], input[type="date"], input[type="time"], input[type="number"], select, .flatpickr-input {
                -webkit-appearance: none !important; appearance: none !important; background: transparent !important; border: none !important; box-shadow: none !important; color: #000 !important; padding: 0 !important; margin: 0 !important; font-weight: normal; background-image: none !important; 
            }
            select { text-indent: 0.01px; text-overflow: ""; }
            ::placeholder { color: transparent !important; opacity: 0 !important; }

            /* HEADER */
            .logo-container { text-align: left; margin-bottom: 15px; padding: 0 0 10px 0; border-bottom: 2px solid #000; display: flex; align-items: center; position: relative; }
            .logo-screen { display: none !important; }
            .logo-print { display: block !important; max-width: 150px !important; height: auto; margin-right: 15px; }
            .logo-container::after { content: "REPORTE Control de Calidad"; font-size: 15pt; font-weight: bold; margin-left: 10px; display: block; flex-grow: 1; }
            #print-date-display { display: block !important; position: absolute; right: 0; top: 0; font-size: 10pt; font-weight: bold; }

            .header-info { grid-template-columns: 1fr 1fr 1fr; gap: 5px; border: 1px solid #000; padding: 8px; margin-bottom: 15px; background: #fff !important; }
            .header-info label { color: #000 !important; font-size: 10pt; font-weight: bold; margin-bottom: 2px; }

            /* SECCIONES */
            .section { border: 1px solid #000 !important; margin-bottom: 12px; page-break-inside: avoid; background: #fff !important; }
            .section-header { border-bottom: 1px solid #000; padding: 8px 10px; background: #e0e0e0 !important; font-size: 12pt; font-weight: bold; color: #000 !important; }
            .section-header.completed { background: #e0e0e0 !important; color: #000 !important; }
            .status-indicator { display: none !important; }

            .admin-row { border-bottom: 1px solid #bbb; padding: 8px 10px; background: #fff !important; }
            .admin-question { font-weight: bold; color: #000 !important; margin-bottom: 4px; font-size: 10pt; }
            #devolucion-block, #corregido-block { border: 1px solid #000 !important; background: #fff !important; padding: 5px; margin-top: 6px; }

            /* --- L√ìGICA DE IMPRESI√ìN DE CHECKLIST --- */
            .checklist { padding: 8px 12px; }
            /* Ocultamos checkboxes reales */
            .check-item input[type="checkbox"] { display: none !important; }
            /* Ocultamos todo por defecto */
            .check-item { display: none !important; border-bottom: 1px dotted #ccc; padding: 4px 0; font-size: 10pt; }
            
            /* Mostramos solo los que tienen clase .is-checked-print */
            .check-item.is-checked-print { display: block !important; }
            .check-item.is-checked-print label { color: #000 !important; font-weight: bold; }

            /* ICONOS SEG√öN ESTADO */
            /* Si pas√≥ (OK) */
            .check-item.is-pass-print label::before { content: "‚òë "; font-size: 12pt; margin-right: 4px; font-weight: bold; }
            /* Si fall√≥ (X) */
            .check-item.is-fail-print label::before { content: "‚òí DEFECTO: "; font-size: 12pt; margin-right: 4px; font-weight: bold; }

            /* Mostrar la caja de texto solo si es un fallo */
            .specific-obs { display: none; }
            .check-item.is-fail-print .specific-obs.visible { display: block !important; margin-top: 2px; padding-left: 20px; }
            .check-item.is-fail-print .specific-obs input { border: none !important; font-style: italic; width: 100%; color: #000 !important; background: transparent !important; }

            /* OBSERVACIONES GENERALES */
            .obs-area { border-top: 1px solid #000; padding: 10px; background: #fff !important; }
            .obs-area textarea { border: 1px solid #000 !important; padding: 5px; min-height: 40px; resize: none !important; font-size: 10pt; color: #000 !important; }
            
            /* OCULTAR VAC√çOS */
            .obs-area.empty-print, .section.empty-print { display: none !important; }

            /* FIRMA (MANTENIDA EXACTA AL ORIGINAL) */
            .signature-pad-wrapper { border: none; background: transparent; padding: 0; margin: 0 auto 5px auto !important; display: block !important; float: none !important; page-break-inside: avoid; width: 300px; text-align: center; position: relative; }
            .signature-pad-body { box-shadow: none; border: none !important; background-color: #fff !important; height: 120px; margin-bottom: 2px; }
            .signature-label { display: block !important; font-size: 9pt !important; font-weight: normal !important; color: #555 !important; text-align: center; margin-bottom: 5px; }

            .responsible-name-container { text-align: center; margin: 20px auto 40px auto !important; width: 300px; display: block !important; page-break-inside: avoid; }
            .responsible-name-container label { display: none !important; }
            .responsible-name-container input#responsibleName { display: block !important; border: none !important; text-align: center; padding: 0 !important; margin: 0 auto; font-size: 11pt !important; font-weight: bold; color: #000 !important; background-color: transparent !important; box-shadow: none !important; border-bottom: 1px solid #000 !important; width: 100%; padding-bottom: 5px !important; margin-bottom: 5px !important; }
            .responsible-name-container::after { content: "Nombre del Responsable"; display: block; text-align: center; font-size: 9pt; font-style: italic; color: #555; margin-top: 2px; }
        }
    </style>
</head>
<body>
    <div id="save-indicator">üíæ Guardado</div>

<div class="container">
    
<div class="logo-container">
    <img src="assets/logo.png" class="logo-screen" alt="GAS Paint & Detail Logo" onerror="this.style.display='none'">
    <img src="assets/logo.jpeg" class="logo-print" alt="GAS Paint & Detail Logo (Impresi√≥n)" onerror="this.style.display='none'">
    <div id="print-date-display"></div>
</div>
    
    <h1>Control de Calidad</h1>

    <div class="header-info">
        <div class="form-group">
            <label>N¬∫ Orden de Trabajo:</label>
            <input type="text" id="orderNum" placeholder="OT-0000" maxlength="7">
        </div>
        <div class="form-group">
            <label>Placa:</label>
            <input type="text" id="plate" class="uppercase-input" maxlength="9" placeholder="Ej: XYZ-1234">
        </div>
        <div class="form-group">
            <label>Marca del Veh√≠culo:</label>
            <input type="text" id="brand" placeholder="Ej: Toyota"> 
        </div>
    </div>

    <div class="section" id="sec-sistema">
        <div class="section-header">
            <span><span class="print-hidden-icon">üìù</span> <span class="section-index">A.</span> ORDEN DE TRABAJO Y SISTEMA</span>
            <span class="status-indicator">PENDIENTE</span>
        </div>
        
        <div class="admin-row">
            <span class="admin-question">1. ¬øSe encuentra la Orden de Trabajo finalizada en el Sistema?</span>
            <div class="input-cluster">
                <select id="sys-finalizada">
                    <option value="" selected disabled hidden>Seleccione...</option>
                    <option value="SI">S√ç</option>
                    <option value="NO">NO</option>
                </select>
                <input type="text" id="sys-finalizada-date" class="flat-date" title="Fecha" placeholder="DD/MM/YYYY">
                <input type="text" id="sys-finalizada-time" class="flat-time" title="Hora" placeholder="HH:MM">
            </div>
        </div>

        <div class="admin-row">
            <span class="admin-question">2.a. ¬øTodos los servicios en la Orden verificables, se ejecutaron?</span>
            <div class="input-cluster">
                <select id="sys-ejecutados" onchange="saveForm()">
                    <option value="" selected disabled hidden>Seleccione...</option>
                    <option value="SI">S√ç</option>
                    <option value="NO">NO</option>
                </select>
                <input type="text" id="sys-ejecutados-date" class="flat-date" title="Fecha" placeholder="DD/MM/YYYY">
                <input type="text" id="sys-ejecutados-time" class="flat-time" title="Hora" placeholder="HH:MM">
            </div>
            
            <div id="devolucion-block" class="highlight-box">
                <span class="sub-note">2.b. En caso negativo, devolver a Operaciones el veh√≠culo y este Formulario.</span>
                <div class="input-cluster" style="margin-top:5px;">
                    <label>Devuelto:</label>
                    <input type="text" id="devuelto-date" class="flat-date" title="Fecha Devoluci√≥n" placeholder="DD/MM/YYYY">
                    <input type="text" id="devuelto-time" class="flat-time" title="Hora Devoluci√≥n" placeholder="HH:MM">
                </div>
            </div>

            <div id="corregido-block" class="highlight-box">
                <span class="sub-note">3. Revisado por Operaciones y debidamente corregidos los servicios incompletos.</span>
                <div class="input-cluster" style="margin-top:5px;">
                    <label>Corregido:</label>
                    <input type="text" id="corregido-date" class="flat-date" title="Fecha Correcci√≥n" placeholder="DD/MM/YYYY">
                    <input type="text" id="corregido-time" class="flat-time" title="Hora Correcci√≥n" placeholder="HH:MM">
                </div>
                <div id="corregido-error" class="error-text">La fecha/hora de correcci√≥n no puede ser anterior a la fecha/hora de devoluci√≥n.</div>
            </div>
        </div>

        <div class="checklist">
            <div class="check-item" style="background-color: var(--input-bg); padding: 10px;">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="admin-ok" class="check-pass" onchange="checkSection('sec-sistema'); saveForm();">
                    <label for="admin-ok"><strong>CONFIRMAR:</strong> La revisi√≥n administrativa est√° completa.</label>
                </div>
            </div>
        </div>
        <div class="obs-area">
            <label class="form-group">Observaciones:</label>
            <textarea id="obs-sistema" placeholder="Observaciones"></textarea>
        </div>
    </div>

    <div class="section" id="sec-pintura">
        <div class="section-header"><span><span class="print-hidden-icon">üñåÔ∏è</span> <span class="section-index">B.</span> PINTURA</span><span class="status-indicator">PENDIENTE</span></div>
        <div class="checklist">
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="p1" class="check-pass" onchange="handleCheckPair('p1', 'p1-fail', 'p1-obs-box'); checkSection('sec-pintura'); saveForm();">
                    <input type="checkbox" id="p1-fail" class="check-fail" title="Marcar defecto" onchange="handleCheckPair('p1-fail', 'p1', 'p1-obs-box'); checkSection('sec-pintura'); saveForm();">
                    <label for="p1">La textura del transparente es la adecuada conforme con la originalidad del veh√≠culo</label>
                </div>
                <div id="p1-obs-box" class="specific-obs"><input type="text" id="p1-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>

            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="p2" class="check-pass" onchange="handleCheckPair('p2', 'p2-fail', 'p2-obs-box'); checkSection('sec-pintura'); saveForm();">
                    <input type="checkbox" id="p2-fail" class="check-fail" title="Marcar defecto" onchange="handleCheckPair('p2-fail', 'p2', 'p2-obs-box'); checkSection('sec-pintura'); saveForm();">
                    <label for="p2">Los bordes, filos y l√≠neas repasadas est√°n libres de excesos de transparente o pintura</label>
                </div>
                <div id="p2-obs-box" class="specific-obs"><input type="text" id="p2-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>

            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="p3" class="check-pass" onchange="handleCheckPair('p3', 'p3-fail', 'p3-obs-box'); checkSection('sec-pintura'); saveForm();">
                    <input type="checkbox" id="p3-fail" class="check-fail" title="Marcar defecto" onchange="handleCheckPair('p3-fail', 'p3', 'p3-obs-box'); checkSection('sec-pintura'); saveForm();">
                    <label for="p3">Las l√≠neas de las piezas repintadas son id√©nticas a las originales</label>
                </div>
                <div id="p3-obs-box" class="specific-obs"><input type="text" id="p3-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>

            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="p4" class="check-pass" onchange="handleCheckPair('p4', 'p4-fail', 'p4-obs-box'); checkSection('sec-pintura'); saveForm();">
                    <input type="checkbox" id="p4-fail" class="check-fail" title="Marcar defecto" onchange="handleCheckPair('p4-fail', 'p4', 'p4-obs-box'); checkSection('sec-pintura'); saveForm();">
                    <label for="p4">Las superficies pintadas est√°n libres de defectos de repintado (rayas, opacamiento, manchas)</label>
                </div>
                <div id="p4-obs-box" class="specific-obs"><input type="text" id="p4-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>

            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="p5" class="check-pass" onchange="handleCheckPair('p5', 'p5-fail', 'p5-obs-box'); checkSection('sec-pintura'); saveForm();">
                    <input type="checkbox" id="p5-fail" class="check-fail" title="Marcar defecto" onchange="handleCheckPair('p5-fail', 'p5', 'p5-obs-box'); checkSection('sec-pintura'); saveForm();">
                    <label for="p5">Los empaques externos est√°n libres de residuos de pintura, pulimento, o cualquier suciedad</label>
                </div>
                <div id="p5-obs-box" class="specific-obs"><input type="text" id="p5-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>

            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="p6" class="check-pass" onchange="handleCheckPair('p6', 'p6-fail', 'p6-obs-box'); checkSection('sec-pintura'); saveForm();">
                    <input type="checkbox" id="p6-fail" class="check-fail" title="Marcar defecto" onchange="handleCheckPair('p6-fail', 'p6', 'p6-obs-box'); checkSection('sec-pintura'); saveForm();">
                    <label for="p6">En caso negativo, revisar contra la Recepci√≥n del Auto por da√±os que debieron eliminarse en el taller</label>
                </div>
                <div id="p6-obs-box" class="specific-obs"><input type="text" id="p6-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="p7" class="check-pass" onchange="handleCheckPair('p7', 'p7-fail', 'p7-obs-box'); checkSection('sec-pintura'); saveForm();">
                    <input type="checkbox" id="p7-fail" class="check-fail" title="Marcar defecto" onchange="handleCheckPair('p7-fail', 'p7', 'p7-obs-box'); checkSection('sec-pintura'); saveForm();">
                    <label for="p7">En caso de Correcci√≥n de Pintura Total: verificar si los servicios incompletos fueron corregidos</label>
                </div>
                <div id="p7-obs-box" class="specific-obs"><input type="text" id="p7-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
        </div>
        <div class="obs-area"><label class="form-group">Observaciones:</label><textarea id="obs-pintura" placeholder="Defectos encontrados, correcciones pendientes..."></textarea></div>
    </div>

    <div class="section" id="sec-armado">
        <div class="section-header"><span><span class="print-hidden-icon">üî©</span> <span class="section-index">C.</span> ARMADO Y AJUSTE DE PIEZAS</span><span class="status-indicator">PENDIENTE</span></div>
        <div class="checklist">
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="a1" class="check-pass" onchange="handleCheckPair('a1', 'a1-fail', 'a1-obs-box'); checkSection('sec-armado'); saveForm();">
                    <input type="checkbox" id="a1-fail" class="check-fail" onchange="handleCheckPair('a1-fail', 'a1', 'a1-obs-box'); checkSection('sec-armado'); saveForm();">
                    <label for="a1">El interior de las piezas reparadas est√° libre de residuos de pulimento o suciedad</label>
                </div>
                <div id="a1-obs-box" class="specific-obs"><input type="text" id="a1-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="a2" class="check-pass" onchange="handleCheckPair('a2', 'a2-fail', 'a2-obs-box'); checkSection('sec-armado'); saveForm();">
                    <input type="checkbox" id="a2-fail" class="check-fail" onchange="handleCheckPair('a2-fail', 'a2', 'a2-obs-box'); checkSection('sec-armado'); saveForm();">
                    <label for="a2">Las piezas reparadas y aleda√±as son m√≥viles, abren y cierran con la suavidad original y sin golpes</label>
                </div>
                <div id="a2-obs-box" class="specific-obs"><input type="text" id="a2-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="a3" class="check-pass" onchange="handleCheckPair('a3', 'a3-fail', 'a3-obs-box'); checkSection('sec-armado'); saveForm();">
                    <input type="checkbox" id="a3-fail" class="check-fail" onchange="handleCheckPair('a3-fail', 'a3', 'a3-obs-box'); checkSection('sec-armado'); saveForm();">
                    <label for="a3">Las piezas ajustan correctamente y no presentan levantamientos o desalineaciones</label>
                </div>
                <div id="a3-obs-box" class="specific-obs"><input type="text" id="a3-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="a4" class="check-pass" onchange="handleCheckPair('a4', 'a4-fail', 'a4-obs-box'); checkSection('sec-armado'); saveForm();">
                    <input type="checkbox" id="a4-fail" class="check-fail" onchange="handleCheckPair('a4-fail', 'a4', 'a4-obs-box'); checkSection('sec-armado'); saveForm();">
                    <label for="a4">Los niveles de aceite, l√≠quido de frenos y refrigerante son los adecuados</label>
                </div>
                <div id="a4-obs-box" class="specific-obs"><input type="text" id="a4-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="a5" class="check-pass" onchange="handleCheckPair('a5', 'a5-fail', 'a5-obs-box'); checkSection('sec-armado'); saveForm();">
                    <input type="checkbox" id="a5-fail" class="check-fail" onchange="handleCheckPair('a5-fail', 'a5', 'a5-obs-box'); checkSection('sec-armado'); saveForm();">
                    <label for="a5">Las luces y testigos funcionan correctamente</label>
                </div>
                <div id="a5-obs-box" class="specific-obs"><input type="text" id="a5-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="a6" class="check-pass" onchange="handleCheckPair('a6', 'a6-fail', 'a6-obs-box'); checkSection('sec-armado'); saveForm();">
                    <input type="checkbox" id="a6-fail" class="check-fail" onchange="handleCheckPair('a6-fail', 'a6', 'a6-obs-box'); checkSection('sec-armado'); saveForm();">
                    <label for="a6">Las molduras, parrillas, empaques, escobillas u otras piezas est√°n limpias y sin da√±os</label>
                </div>
                <div id="a6-obs-box" class="specific-obs"><input type="text" id="a6-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="a7" class="check-pass" onchange="handleCheckPair('a7', 'a7-fail', 'a7-obs-box'); checkSection('sec-armado'); saveForm();">
                    <input type="checkbox" id="a7-fail" class="check-fail" onchange="handleCheckPair('a7-fail', 'a7', 'a7-obs-box'); checkSection('sec-armado'); saveForm();">
                    <label for="a7">Los vidrios no presentan da√±os derivados del proceso de reparaci√≥n</label>
                </div>
                <div id="a7-obs-box" class="specific-obs"><input type="text" id="a7-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="a8" class="check-pass" onchange="handleCheckPair('a8', 'a8-fail', 'a8-obs-box'); checkSection('sec-armado'); saveForm();">
                    <input type="checkbox" id="a8-fail" class="check-fail" onchange="handleCheckPair('a8-fail', 'a8', 'a8-obs-box'); checkSection('sec-armado'); saveForm();">
                    <label for="a8">El exterior del auto est√° libre de suciedad producida por el proceso de reparaci√≥n (polvo, cinta, residuos)</label>
                </div>
                <div id="a8-obs-box" class="specific-obs"><input type="text" id="a8-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
        </div>
        <div class="obs-area"><label class="form-group">Observaciones Armado/Ajuste:</label><textarea id="obs-armado" placeholder="Observaciones"></textarea></div>
    </div>

    <div class="section" id="sec-pulido">
        <div class="section-header"><span><span class="print-hidden-icon">‚ú®</span> <span class="section-index">D.</span> PULIDO Y EXTERIOR</span><span class="status-indicator">PENDIENTE</span></div>
        <div class="checklist">
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="pu1" class="check-pass" onchange="handleCheckPair('pu1', 'pu1-fail', 'pu1-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <input type="checkbox" id="pu1-fail" class="check-fail" onchange="handleCheckPair('pu1-fail', 'pu1', 'pu1-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <label for="pu1">Sin rayas, manchas u opacamiento por pulido</label>
                </div>
                <div id="pu1-obs-box" class="specific-obs"><input type="text" id="pu1-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="pu2" class="check-pass" onchange="handleCheckPair('pu2', 'pu2-fail', 'pu2-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <input type="checkbox" id="pu2-fail" class="check-fail" onchange="handleCheckPair('pu2-fail', 'pu2', 'pu2-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <label for="pu2">Vidrios pulidos (sin manchas ni marcas de agua)</label>
                </div>
                <div id="pu2-obs-box" class="specific-obs"><input type="text" id="pu2-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="pu3" class="check-pass" onchange="handleCheckPair('pu3', 'pu3-fail', 'pu3-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <input type="checkbox" id="pu3-fail" class="check-fail" onchange="handleCheckPair('pu3-fail', 'pu3', 'pu3-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <label for="pu3">Partes negras acondicionadas</label>
                </div>
                <div id="pu3-obs-box" class="specific-obs"><input type="text" id="pu3-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="pu4" class="check-pass" onchange="handleCheckPair('pu4', 'pu4-fail', 'pu4-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <input type="checkbox" id="pu4-fail" class="check-fail" onchange="handleCheckPair('pu4-fail', 'pu4', 'pu4-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <label for="pu4">Manillas de puertas limpias (interior y exterior)</label>
                </div>
                <div id="pu4-obs-box" class="specific-obs"><input type="text" id="pu4-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="pu5" class="check-pass" onchange="handleCheckPair('pu5', 'pu5-fail', 'pu5-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <input type="checkbox" id="pu5-fail" class="check-fail" onchange="handleCheckPair('pu5-fail', 'pu5', 'pu5-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <label for="pu5">Torpedo y escobillas detallados correctamente</label>
                </div>
                <div id="pu5-obs-box" class="specific-obs"><input type="text" id="pu5-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="pu6" class="check-pass" onchange="handleCheckPair('pu6', 'pu6-fail', 'pu6-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <input type="checkbox" id="pu6-fail" class="check-fail" onchange="handleCheckPair('pu6-fail', 'pu6', 'pu6-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <label for="pu6">Bordes del veh√≠culo sin residuos (polish/cera)</label>
                </div>
                <div id="pu6-obs-box" class="specific-obs"><input type="text" id="pu6-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="pu7" class="check-pass" onchange="handleCheckPair('pu7', 'pu7-fail', 'pu7-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <input type="checkbox" id="pu7-fail" class="check-fail" onchange="handleCheckPair('pu7-fail', 'pu7', 'pu7-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <label for="pu7">Superficies externas sin residuos de pulimento</label>
                </div>
                <div id="pu7-obs-box" class="specific-obs"><input type="text" id="pu7-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="pu8" class="check-pass" onchange="handleCheckPair('pu8', 'pu8-fail', 'pu8-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <input type="checkbox" id="pu8-fail" class="check-fail" onchange="handleCheckPair('pu8-fail', 'pu8', 'pu8-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <label for="pu8">Cap√≥, guardabarros, tapa motor, y superficies externas limpias</label>
                </div>
                <div id="pu8-obs-box" class="specific-obs"><input type="text" id="pu8-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="pu9" class="check-pass" onchange="handleCheckPair('pu9', 'pu9-fail', 'pu9-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <input type="checkbox" id="pu9-fail" class="check-fail" onchange="handleCheckPair('pu9-fail', 'pu9', 'pu9-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <label for="pu9">Superficies lavadas correctamente y sin suciedad posterior al proceso</label>
                </div>
                <div id="pu9-obs-box" class="specific-obs"><input type="text" id="pu9-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="pu10" class="check-pass" onchange="handleCheckPair('pu10', 'pu10-fail', 'pu10-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <input type="checkbox" id="pu10-fail" class="check-fail" onchange="handleCheckPair('pu10-fail', 'pu10', 'pu10-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <label for="pu10">Las superficies exteriores est√°n libres de rayas superficiales o da√±os que debieron eliminarse</label>
                </div>
                <div id="pu10-obs-box" class="specific-obs"><input type="text" id="pu10-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="pu11" class="check-pass" onchange="handleCheckPair('pu11', 'pu11-fail', 'pu11-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <input type="checkbox" id="pu11-fail" class="check-fail" onchange="handleCheckPair('pu11-fail', 'pu11', 'pu11-obs-box'); checkSection('sec-pulido'); saveForm();">
                    <label for="pu11">En caso negativo, finalizar en el taller y corregir antes de la entrega</label>
                </div>
                <div id="pu11-obs-box" class="specific-obs"><input type="text" id="pu11-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
        </div>
        <div class="obs-area"><label class="form-group">Observaciones Exterior/Pulido:</label><textarea id="obs-pulido" placeholder="Observaciones"></textarea></div>
    </div>

    <div class="section" id="sec-tapiceria">
        <div class="section-header"><span><span class="print-hidden-icon">üßº</span> <span class="section-index">E.</span> TAPICER√çA E INTERIOR</span><span class="status-indicator">PENDIENTE</span></div>
        <div class="checklist"> 
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t1" class="check-pass" onchange="handleCheckPair('t1','t1-fail','t1-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t1-fail" class="check-fail" onchange="handleCheckPair('t1-fail','t1','t1-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t1">Aspirado de piso y alfombras detallado</label>
                </div>
                <div id="t1-obs-box" class="specific-obs"><input type="text" id="t1-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t2" class="check-pass" onchange="handleCheckPair('t2','t2-fail','t2-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t2-fail" class="check-fail" onchange="handleCheckPair('t2-fail','t2','t2-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t2">Tapicer√≠a aspirada y detallada correctamente</label>
                </div>
                <div id="t2-obs-box" class="specific-obs"><input type="text" id="t2-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t3" class="check-pass" onchange="handleCheckPair('t3','t3-fail','t3-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t3-fail" class="check-fail" onchange="handleCheckPair('t3-fail','t3','t3-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t3">Rejillas de ventilaci√≥n limpias y detalladas</label>
                </div>
                <div id="t3-obs-box" class="specific-obs"><input type="text" id="t3-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t4" class="check-pass" onchange="handleCheckPair('t4','t4-fail','t4-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t4-fail" class="check-fail" onchange="handleCheckPair('t4-fail','t4','t4-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t4">Dash limpio y detallado</label>
                </div>
                <div id="t4-obs-box" class="specific-obs"><input type="text" id="t4-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t5" class="check-pass" onchange="handleCheckPair('t5','t5-fail','t5-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t5-fail" class="check-fail" onchange="handleCheckPair('t5-fail','t5','t5-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t5">Guarda soles limpios y detallados</label>
                </div>
                <div id="t5-obs-box" class="specific-obs"><input type="text" id="t5-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t6" class="check-pass" onchange="handleCheckPair('t6','t6-fail','t6-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t6-fail" class="check-fail" onchange="handleCheckPair('t6-fail','t6','t6-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t6">Consola central limpia y detallada</label>
                </div>
                <div id="t6-obs-box" class="specific-obs"><input type="text" id="t6-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t7" class="check-pass" onchange="handleCheckPair('t7','t7-fail','t7-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t7-fail" class="check-fail" onchange="handleCheckPair('t7-fail','t7','t7-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t7">Guantera y compartimientos limpios</label>
                </div>
                <div id="t7-obs-box" class="specific-obs"><input type="text" id="t7-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t8" class="check-pass" onchange="handleCheckPair('t8','t8-fail','t8-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t8-fail" class="check-fail" onchange="handleCheckPair('t8-fail','t8','t8-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t8">Cielo (techo) detallado y limpio</label>
                </div>
                <div id="t8-obs-box" class="specific-obs"><input type="text" id="t8-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t9" class="check-pass" onchange="handleCheckPair('t9','t9-fail','t9-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t9-fail" class="check-fail" onchange="handleCheckPair('t9-fail','t9','t9-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t9">Asientos detallados y limpios</label>
                </div>
                <div id="t9-obs-box" class="specific-obs"><input type="text" id="t9-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t10" class="check-pass" onchange="handleCheckPair('t10','t10-fail','t10-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t10-fail" class="check-fail" onchange="handleCheckPair('t10-fail','t10','t10-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t10">Empaques externos limpios y detallados</label>
                </div>
                <div id="t10-obs-box" class="specific-obs"><input type="text" id="t10-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t11" class="check-pass" onchange="handleCheckPair('t11','t11-fail','t11-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t11-fail" class="check-fail" onchange="handleCheckPair('t11-fail','t11','t11-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t11">Empaques internos limpios y detallados</label>
                </div>
                <div id="t11-obs-box" class="specific-obs"><input type="text" id="t11-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t12" class="check-pass" onchange="handleCheckPair('t12','t12-fail','t12-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t12-fail" class="check-fail" onchange="handleCheckPair('t12-fail','t12','t12-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t12">Empaque del cap√≥ limpio y detallado</label>
                </div>
                <div id="t12-obs-box" class="specific-obs"><input type="text" id="t12-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t13" class="check-pass" onchange="handleCheckPair('t13','t13-fail','t13-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t13-fail" class="check-fail" onchange="handleCheckPair('t13-fail','t13','t13-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t13">Empaque de la cajuela limpio y detallado</label>
                </div>
                <div id="t13-obs-box" class="specific-obs"><input type="text" id="t13-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t14" class="check-pass" onchange="handleCheckPair('t14','t14-fail','t14-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t14-fail" class="check-fail" onchange="handleCheckPair('t14-fail','t14','t14-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t14">Pantallas y espejos limpios</label>
                </div>
                <div id="t14-obs-box" class="specific-obs"><input type="text" id="t14-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t15" class="check-pass" onchange="handleCheckPair('t15','t15-fail','t15-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t15-fail" class="check-fail" onchange="handleCheckPair('t15-fail','t15','t15-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t15">Pedales correctamente limpios y detallados</label>
                </div>
                <div id="t15-obs-box" class="specific-obs"><input type="text" id="t15-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t16" class="check-pass" onchange="handleCheckPair('t16','t16-fail','t16-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t16-fail" class="check-fail" onchange="handleCheckPair('t16-fail','t16','t16-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t16">Cajuela aspirada y limpia</label>
                </div>
                <div id="t16-obs-box" class="specific-obs"><input type="text" id="t16-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="t17" class="check-pass" onchange="handleCheckPair('t17','t17-fail','t17-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <input type="checkbox" id="t17-fail" class="check-fail" onchange="handleCheckPair('t17-fail','t17','t17-obs-box'); checkSection('sec-tapiceria'); saveForm();">
                    <label for="t17">Habit√°culo/cajuela/batea limpio y detallado (seg√∫n tipo de veh√≠culo)</label>
                </div>
                <div id="t17-obs-box" class="specific-obs"><input type="text" id="t17-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
        </div>
        <div class="obs-area"><label class="form-group">Observaciones Interior:</label><textarea id="obs-interior" placeholder="Observaciones"></textarea></div>
    </div>

    <div class="section" id="sec-control">
        <div class="section-header"><span><span class="print-hidden-icon">‚öôÔ∏è</span> <span class="section-index">F.</span> CONTROL MEC√ÅNICO B√ÅSICO</span><span class="status-indicator">PENDIENTE</span></div>
        <div class="checklist">
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="m1" class="check-pass" onchange="handleCheckPair('m1','m1-fail','m1-obs-box'); checkSection('sec-control'); saveForm();">
                    <input type="checkbox" id="m1-fail" class="check-fail" onchange="handleCheckPair('m1-fail','m1','m1-obs-box'); checkSection('sec-control'); saveForm();">
                    <label for="m1">Niveles de l√≠quidos adecuados (aceite, frenos, refrigerante)</label>
                </div>
                <div id="m1-obs-box" class="specific-obs"><input type="text" id="m1-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="m2" class="check-pass" onchange="handleCheckPair('m2','m2-fail','m2-obs-box'); checkSection('sec-control'); saveForm();">
                    <input type="checkbox" id="m2-fail" class="check-fail" onchange="handleCheckPair('m2-fail','m2','m2-obs-box'); checkSection('sec-control'); saveForm();">
                    <label for="m2">Luces y testigos funcionando</label>
                </div>
                <div id="m2-obs-box" class="specific-obs"><input type="text" id="m2-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
            <div class="check-item">
                <div class="check-row-wrapper">
                    <input type="checkbox" id="m3" class="check-pass" onchange="handleCheckPair('m3','m3-fail','m3-obs-box'); checkSection('sec-control'); saveForm();">
                    <input type="checkbox" id="m3-fail" class="check-fail" onchange="handleCheckPair('m3-fail','m3','m3-obs-box'); checkSection('sec-control'); saveForm();">
                    <label for="m3">Veh√≠culo listo para la entrega sin reportes pendientes</label>
                </div>
                <div id="m3-obs-box" class="specific-obs"><input type="text" id="m3-txt" placeholder="Describa el defecto..." oninput="saveForm()"></div>
            </div>
        </div>
        <div class="obs-area"><label class="form-group">Observaciones Control Mec√°nico:</label><textarea id="obs-control" placeholder="Observaciones"></textarea></div>
    </div>

    
    <div class="form-group responsible-name-container">
        <label>Nombre del Responsable:</label>
        <input type="text" id="responsibleName" class="uppercase-input" placeholder="Nombre y Apellido">
    </div>

    <div class="signature-pad-wrapper">
        <div style="width: 100%; max-width: 600px; margin-bottom:5px; display:flex; justify-content:space-between;">
            <label>Firma del Responsable:</label>
        </div>
        <div class="signature-pad-body">
            <canvas id="signature-pad"></canvas>
            <span class="signature-label">Firmar aqu√≠</span>
        </div>
        <div class="signature-actions">
            <button class="btn-small" onclick="borrarFirma()">Borrar Firma</button>
        </div>
    </div>
    <div class="button-group">
        <button class="btn-clear" onclick="limpiarFormulario()">Limpiar</button>
        <button id="btn-print" class="btn-submit" onclick="generarReporte()">Finalizar e Imprimir Reporte</button>
    </div>

    <div class="footer-info">
        <span class="hover-underline" id="version-link">Versi√≥n 1.3.0 - Control de Calidad GAS</span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    const STORAGE_KEY = "form-calidad-gas-v2";
    const HISTORY_KEY = "form-calidad-history";
    const MAX_HISTORY = 5;

    let datePickers = [];
    let timePickers = [];

    // --- NUEVA FUNCI√ìN: MANEJO DE PARES (CHECK VERDE / CHECK ROJO) ---
    function handleCheckPair(clickedId, otherId, obsBoxId) {
        const clicked = document.getElementById(clickedId);
        const other = document.getElementById(otherId);
        const obsBox = document.getElementById(obsBoxId);
        
        if (!clicked || !other) return;

        // Exclusividad: Si marcas uno, se desmarca el otro
        if (clicked.checked) {
            other.checked = false;
        }

        // Visibilidad de la caja de observaci√≥n
        if (obsBox) {
            // Si el que se marc√≥ es el FAIL (contiene 'fail')
            if (clickedId.includes('fail') && clicked.checked) {
                obsBox.classList.add('visible');
                const input = obsBox.querySelector('input');
                if(input) setTimeout(() => input.focus(), 100);
            } 
            // Si se marc√≥ el PASS (OK)
            else if (!clickedId.includes('fail') && clicked.checked) {
                obsBox.classList.remove('visible');
            }
            // Si ninguno est√° marcado
            else if (!clicked.checked && !other.checked) {
                obsBox.classList.remove('visible');
            }
        }
    }

    // --- MODIFICADA: VERIFICACI√ìN DE SECCI√ìN ---
    function checkSection(sectionId) {
        const section = document.getElementById(sectionId);
        const header = section.querySelector('.section-header');
        const indicator = section.querySelector('.status-indicator');
        
        // Obtenemos solo los checkboxes "PASS" (los verdes) para iterar
        const passCheckboxes = Array.from(section.querySelectorAll('.check-pass'));
        
        let allChecked = true;

        if (passCheckboxes.length > 0) {
            // L√≥gica nueva: Est√° completo si (pass est√° checked) O (fail est√° checked)
            passCheckboxes.forEach(passBox => {
                const failBoxId = passBox.id + '-fail';
                const failBox = document.getElementById(failBoxId);
                
                // Si pass NO est√° marcado Y (no existe failBox O failBox no est√° marcado)
                if (!passBox.checked && (!failBox || !failBox.checked)) {
                    allChecked = false;
                }
            });
        } else {
            // L√≥gica antigua (para secciones sin .check-pass, si las hubiera)
            const checkboxes = section.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(box => {
                if (!box.checked) allChecked = false;
            });
        }

        if (allChecked) {
            header.classList.add('completed');
            indicator.textContent = "‚úî COMPLETADO";
        } else {
            header.classList.remove('completed');
            indicator.textContent = "PENDIENTE";
        }
        
        updateSectionProgress(sectionId);
    }

    // --- MODIFICADA: PROGRESO DE SECCI√ìN ---
    function updateSectionProgress(sectionId) {
        const section = document.getElementById(sectionId);
        if (!section) return;

        // Intentar usar l√≥gica de pares primero
        const passCheckboxes = Array.from(section.querySelectorAll('.check-pass'));
        let total = passCheckboxes.length;
        let checkedCount = 0;

        if (total > 0) {
            passCheckboxes.forEach(passBox => {
                const failBox = document.getElementById(passBox.id + '-fail');
                if (passBox.checked || (failBox && failBox.checked)) {
                    checkedCount++;
                }
            });
        } else {
            // Fallback l√≥gica simple
            const allChecks = Array.from(section.querySelectorAll('input[type="checkbox"]'))
                .filter(cb => !cb.id.includes('-ok'));
            total = allChecks.length;
            if (total === 0) return;
            checkedCount = allChecks.filter(cb => cb.checked).length;
        }

        const progress = (checkedCount / total) * 100;

        let progressBar = section.querySelector('.section-progress-bar');
        if (!progressBar) {
            progressBar = document.createElement('div');
            progressBar.className = 'section-progress-bar';
            const obs = section.querySelector('.obs-area');
            if (obs) obs.insertAdjacentElement('beforebegin', progressBar);
            else section.appendChild(progressBar);
        }

        let fill = progressBar.querySelector('.section-progress-fill');
        if (!fill) {
            fill = document.createElement('div');
            fill.className = 'section-progress-fill';
            progressBar.appendChild(fill);
        }
        fill.style.width = progress + '%';
    }

    function updateAllSectionProgress() {
        ["sec-sistema", "sec-pintura", "sec-armado", "sec-pulido", "sec-tapiceria", "sec-control"].forEach(id => {
             if(document.getElementById(id)) checkSection(id);
        });
    }

    function initFlatpickr() {
        datePickers = Array.from(document.querySelectorAll(".flat-date")).map(el => flatpickr(el, {
            dateFormat: "Y-m-d", altInput: true, altFormat: "d/m/Y", allowInput: true, clickOpens: true,
            onChange: function(selectedDates, dateStr, instance) { saveForm(); validateCorrectionAfterReturn(); }
        }));
        timePickers = Array.from(document.querySelectorAll(".flat-time")).map(el => flatpickr(el, {
            enableTime: true, noCalendar: true, dateFormat: "H:i", altInput: true, altFormat: "h:i K",
            time_24hr: false, allowInput: true, clickOpens: true, minuteIncrement: 1,
            onChange: function(selectedDates, dateStr, instance) { saveForm(); validateCorrectionAfterReturn(); }
        }));
    }

    function getDateTimeFromInputs(dateId, timeId) {
        const dateEl = document.getElementById(dateId);
        if (!dateEl || !dateEl.value) return null;
        const timeEl = document.getElementById(timeId);
        const dateStr = dateEl.value; 
        const timeStr = (timeEl && timeEl.value) ? timeEl.value : "00:00";
        const iso = dateStr + "T" + timeStr + ":00";
        const dt = new Date(iso);
        if (isNaN(dt.getTime())) return null;
        return dt;
    }

    function validateCorrectionAfterReturn() {
        const devuelto = getDateTimeFromInputs("devuelto-date", "devuelto-time");
        const corregido = getDateTimeFromInputs("corregido-date", "corregido-time");
        const errorEl = document.getElementById("corregido-error");
        const corregidoDateEl = document.getElementById("corregido-date");
        const corregidoTimeEl = document.getElementById("corregido-time");
        const btnPrint = document.getElementById("btn-print");

        if (!devuelto || !corregido) {
            if (errorEl) errorEl.classList.remove("visible");
            if (corregidoDateEl) corregidoDateEl.classList.remove("input-invalid");
            if (corregidoTimeEl) corregidoTimeEl.classList.remove("input-invalid");
            if (btnPrint) btnPrint.removeAttribute("disabled");
            return true;
        }

        if (corregido < devuelto) {
            if (errorEl) errorEl.classList.add("visible");
            if (corregidoDateEl) corregidoDateEl.classList.add("input-invalid");
            if (corregidoTimeEl) corregidoTimeEl.classList.add("input-invalid");
            if (btnPrint) btnPrint.setAttribute("disabled", "true");
            return false;
        } else {
            if (errorEl) errorEl.classList.remove("visible");
            if (corregidoDateEl) corregidoDateEl.classList.remove("input-invalid");
            if (corregidoTimeEl) corregidoTimeEl.classList.remove("input-invalid");
            if (btnPrint) btnPrint.removeAttribute("disabled");
            return true;
        }
    }

    function saveForm() {
        const data = {};
        document.querySelectorAll("input, select, textarea").forEach(el => {
            if (!el.id) return; 
            if (el.type === "checkbox") {
                data[el.id] = el.checked;
            } else {
                data[el.id] = el.value;
            }
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        const indicator = document.getElementById('save-indicator');
        indicator.style.opacity = 1;
        setTimeout(() => { indicator.style.opacity = 0; }, 900);
    }

    function loadForm() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);

        for (let id in data) {
            const el = document.getElementById(id);
            if (!el) continue;
            if (el.type === "checkbox") {
                el.checked = data[id];
                // L√ìGICA DE RECUPERACI√ìN PARA CAJAS DE TEXTO OCULTAS
                if (data[id] === true && id.includes('fail')) {
                    const baseId = id.split('-fail')[0];
                    const obsBox = document.getElementById(baseId + '-obs-box');
                    if (obsBox) obsBox.classList.add('visible');
                }
            } else {
                el.value = data[id];
            }
        }

        if (datePickers && datePickers.length) {
            datePickers.forEach(inst => { try { if (inst.input && inst.input.value) inst.setDate(inst.input.value, false, "Y-m-d"); } catch (e) {} });
        }
        if (timePickers && timePickers.length) {
            timePickers.forEach(inst => { try { if (inst.input && inst.input.value) inst.setDate(inst.input.value, false, "H:i"); } catch (e) {} });
        }

        updateAllSectionProgress();
        validateCorrectionAfterReturn();
        actualizarBloquesAdmin();
    }

    // --- Funciones de Historial Local ---
    function saveToHistory() {
        const current = localStorage.getItem(STORAGE_KEY);
        if (!current) return;
        let history = [];
        try { const stored = localStorage.getItem(HISTORY_KEY); history = stored ? JSON.parse(stored) : []; } catch (e) {}
        history.push({ data: current, timestamp: new Date().toLocaleString('es-ES') });
        if (history.length > MAX_HISTORY) history.shift();
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }

    function getHistory() {
        try { const stored = localStorage.getItem(HISTORY_KEY); return stored ? JSON.parse(stored) : []; } catch (e) { return []; }
    }

    function restoreFromHistory(index) {
        const history = getHistory();
        if (index >= 0 && index < history.length) {
            localStorage.setItem(STORAGE_KEY, history[index].data);
            window.location.reload();
        }
    }

    function showHistoryModal() {
        const history = getHistory();
        if (!history || !history.length) { showRichToast('', 'No hay historial guardado', 'info', 3000); return; }
        const overlay = document.createElement('div'); overlay.className = 'modal-overlay'; overlay.tabIndex = -1;
        const dialog = document.createElement('div'); dialog.className = 'history-modal';
        const title = document.createElement('div'); title.className = 'hm-title'; title.textContent = 'Historial de Cambios';
        const list = document.createElement('ul'); list.className = 'hm-list';
        history.forEach((entry, idx) => {
            const li = document.createElement('li');
            const label = document.createElement('span'); label.textContent = entry.timestamp;
            const btn = document.createElement('button'); btn.className = 'hm-restore'; btn.textContent = 'Restaurar';
            btn.addEventListener('click', () => restoreFromHistory(idx));
            li.appendChild(label); li.appendChild(btn); list.appendChild(li);
        });
        const closeDiv = document.createElement('div'); closeDiv.className = 'hm-close';
        const closeBtn = document.createElement('button'); closeBtn.className = 'btn-close-history'; closeBtn.textContent = 'Cerrar';
        closeDiv.appendChild(closeBtn);
        dialog.appendChild(title); dialog.appendChild(list); dialog.appendChild(closeDiv);
        overlay.appendChild(dialog); document.body.appendChild(overlay);
        function closeModal() { try { dialog.classList.add('animate-out'); } catch (e) {} setTimeout(() => { if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay); }, 180); }
        closeBtn.addEventListener('click', closeModal);
        overlay.addEventListener('click', (ev) => { if (ev.target === overlay) closeModal(); });
    }

    // --- Di√°logo de confirmaci√≥n visual ---
    function showConfirm(options) {
        const title = options.title || 'Confirmar';
        const message = options.message || '';
        const confirmText = options.confirmText || 'Confirmar';
        const cancelText = options.cancelText || 'Cancelar';
        const onConfirm = typeof options.onConfirm === 'function' ? options.onConfirm : () => {};
        const onCancel = typeof options.onCancel === 'function' ? options.onCancel : () => {};

        if (document.querySelector('.modal-overlay')) return;

        const overlay = document.createElement('div'); overlay.className = 'modal-overlay'; overlay.tabIndex = -1;
        const dialog = document.createElement('div'); dialog.className = 'confirm-dialog';
        const titleEl = document.createElement('div'); titleEl.className = 'cd-title'; titleEl.textContent = title;
        const msgEl = document.createElement('div'); msgEl.className = 'cd-message'; msgEl.textContent = message;
        const actions = document.createElement('div'); actions.className = 'cd-actions';
        const btnCancel = document.createElement('button'); btnCancel.className = 'btn-cancel'; btnCancel.textContent = cancelText;
        const btnConfirm = document.createElement('button'); btnConfirm.className = 'btn-confirm btn-clear'; btnConfirm.textContent = confirmText;

        actions.appendChild(btnCancel); actions.appendChild(btnConfirm);
        dialog.appendChild(titleEl); dialog.appendChild(msgEl); dialog.appendChild(actions);
        overlay.appendChild(dialog); document.body.appendChild(overlay);

        const previousActive = document.activeElement;
        btnCancel.focus();

        function closeDialog(result) {
            try { dialog.classList.add('animate-out'); } catch (e) {}
            setTimeout(() => { if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay); try { if (previousActive) previousActive.focus(); } catch (e) {} if (result) onConfirm(); else onCancel(); }, 180);
        }

        btnCancel.addEventListener('click', () => closeDialog(false));
        btnConfirm.addEventListener('click', () => closeDialog(true));
        overlay.addEventListener('click', (ev) => { if (ev.target === overlay) closeDialog(false); });
    }

    function limpiarFormulario() {
        const hasData = localStorage.getItem(STORAGE_KEY) !== null;
        if (!hasData) { showRichToast('Formulario vac√≠o', 'No hay datos para limpiar.', 'info', 3000); return; }

        showConfirm({
            title: 'Limpiar formulario',
            message: '¬øEst√° seguro que desea limpiar todo el formulario? Se perder√°n todos los datos guardados.',
            confirmText: 'Limpiar', cancelText: 'Cancelar',
            onConfirm: () => {
                saveToHistory();
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(STORAGE_KEY + "_sig");
                if(signaturePad) signaturePad.clear();
                
                document.querySelectorAll('input[type="text"], input[type="date"], input[type="time"], input[type="number"], select, textarea').forEach(el => { el.value = ''; });
                document.querySelectorAll('input[type="checkbox"]').forEach(el => { el.checked = false; });
                document.querySelectorAll('.specific-obs').forEach(el => el.classList.remove('visible'));

                updateAllSectionProgress();
                
                showRichToast('Formulario limpiado', 'Los datos han sido borrados. Tienes 30 segundos para deshacer.', 'info', 30000, [{
                    label: 'Deshacer', className: '', onClick: () => { const history = getHistory(); if (history.length > 0) restoreFromHistory(history.length - 1); }
                }]);
                setTimeout(() => { window.location.reload(); }, 32000);
            }
        });
    }

    function formatDateForPrint(d = new Date()) {
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
    }

    function addPrintDate() {
        let el = document.querySelector('.print-date');
        if (!el) { el = document.createElement('div'); el.className = 'print-date'; el.setAttribute('aria-hidden', 'true'); document.body.appendChild(el); }
    }
    function removePrintDate() {
        const el = document.querySelector('.print-date'); if (el && el.parentNode) el.parentNode.removeChild(el);
    }

    function showToast(message, kind = 'success', duration = 2800) { showRichToast('', message, kind, duration); }

    function showRichToast(title, message, kind = 'success', duration = 3000, actions = []) {
        let container = document.querySelector('.toast-container');
        if (!container) { container = document.createElement('div'); container.className = 'toast-container'; document.body.appendChild(container); }

        const normalize = s => (s || '').toString().replace(/\s+/g, ' ').trim();
        const keyRaw = (kind || '') + '|' + normalize(title) + '|' + normalize(message);
        const key = encodeURIComponent(keyRaw);

        if (!window.__activeToastKeys) window.__activeToastKeys = new Set();
        const existingToasts = Array.from(container.querySelectorAll('.toast'));
        const matching = existingToasts.find(ex => ex.dataset && ex.dataset.toastKey === key);
        if (matching || window.__activeToastKeys.has(key)) {
            if (matching) { matching.__pulseActive = true; try { matching.style.animation = 'toastPulse .28s ease'; } catch (e) {} setTimeout(() => { try { matching.style.animation = ''; } catch (e) {} matching.__pulseActive = false; }, 300); }
            return matching || null;
        }
        window.__activeToastKeys.add(key);

        if (existingToasts.length) { existingToasts.forEach((ex) => { try { ex.style.animation = 'toastOut 0.35s cubic-bezier(0.4, 0, 1, 1) forwards'; } catch (e) {} }); setTimeout(() => { existingToasts.forEach((ex) => { try { if (ex && ex.parentNode) ex.parentNode.removeChild(ex); } catch (e) {} }); }, 360); }

        const t = document.createElement('div'); t.dataset.toastKey = key; t.className = 'toast ' + (kind || 'success'); t.setAttribute('tabindex', '0');
        const icons = { success: '‚úîÔ∏è', error: '‚õî', info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è' };
        const iconEl = document.createElement('div'); iconEl.className = 'icon'; iconEl.textContent = icons[kind] || '';
        const content = document.createElement('div'); content.className = 'content';
        if (title) { const titleEl = document.createElement('div'); titleEl.className = 'title'; titleEl.textContent = title; content.appendChild(titleEl); }
        if (message) { const msgEl = document.createElement('div'); msgEl.className = 'message'; msgEl.textContent = message; content.appendChild(msgEl); }
        
        const closeBtn = document.createElement('button'); closeBtn.className = 'close'; closeBtn.innerHTML = '‚úï';
        let actionsContainer = null;
        if (Array.isArray(actions) && actions.length) {
            actionsContainer = document.createElement('div'); actionsContainer.className = 'toast-actions';
            actions.forEach(act => {
                const b = document.createElement('button'); b.className = 'toast-action-btn ' + (act.className || ''); b.textContent = act.label || 'Acci√≥n';
                b.addEventListener('click', (ev) => { ev.stopPropagation(); try { if (typeof act.onClick === 'function') act.onClick(ev, t); } catch (e) { console.error(e); } removeToast(true); });
                actionsContainer.appendChild(b);
            });
        }

        t.appendChild(iconEl); t.appendChild(content); if (actionsContainer) t.appendChild(actionsContainer); t.appendChild(closeBtn);
        container.insertBefore(t, container.firstChild);

        let removed = false; let timeoutId = null;
        const startTimer = (ms) => { if (t.__pulseActive) return; clearTimer(); timeoutId = setTimeout(() => removeToast(true), ms); };
        const clearTimer = () => { if (timeoutId) { clearTimeout(timeoutId); timeoutId = null; } };
        function removeToast(animated) {
            if (removed) return; removed = true; clearTimer();
            t.style.animation = 'toastOut 0.4s cubic-bezier(0.4, 0, 1, 1) forwards';
            setTimeout(() => { if (t && t.parentNode) t.parentNode.removeChild(t); }, 300);
            try { if (t && t.dataset && t.dataset.toastKey) window.__activeToastKeys && window.__activeToastKeys.delete(t.dataset.toastKey); } catch (e) {}
        }

        t.addEventListener('mouseenter', () => clearTimer()); t.addEventListener('mouseleave', () => startTimer(duration));
        closeBtn.addEventListener('click', (e) => { e.stopPropagation(); removeToast(true); });
        startTimer(duration);
        return t;
    }

    function showCustomAlert(title, message, listItems = [], type = 'warning', duration = null, actions = []) {
        const kind = (type === 'error') ? 'error' : (type === 'warning' ? 'warning' : (type === 'info' ? 'info' : 'success'));
        let finalDuration = duration; if (!finalDuration) finalDuration = (kind === 'info') ? 6000 : 3000;
        const composedMessage = []; if (message) composedMessage.push(message);
        if (Array.isArray(listItems) && listItems.length) composedMessage.push(listItems.map(i => '‚Ä¢ ' + i).join('\n'));
        showRichToast(title || '', composedMessage.join('\n\n'), kind, finalDuration, actions);
    }

function generarReporte() {
        // --- VALIDACIONES ---
        const algunaMarcada = [...document.querySelectorAll('input[type="checkbox"]')].some(cb => cb.checked);
        if (!algunaMarcada) { showToast("Debes marcar al menos un punto del checklist.", "warning"); return; }

        const responsable = document.getElementById("responsibleName").value.trim();
        const firmaVacia = signaturePad.isEmpty();
        if (responsable === "" && firmaVacia) { showToast("Falta el nombre del responsable y la firma.", "warning"); return; }
        if (responsable === "") { showToast("Falta el nombre del responsable.", "warning"); return; }
        if (firmaVacia) { showToast("Falta la firma del responsable.", "warning"); return; }

        const today = new Date();
        const dateStr = today.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        document.getElementById('print-date-display').textContent = dateStr;

        const btnPrint = document.getElementById('btn-print');
        if (btnPrint) btnPrint.setAttribute('disabled', 'true');

        const valid = validateCorrectionAfterReturn();
        if (!valid) {
            showCustomAlert("Fechas incorrectas", "La fecha de correcci√≥n no puede ser anterior a la fecha de devoluci√≥n.", [], "error");
            if(btnPrint) btnPrint.removeAttribute('disabled');
            return;
        }

        const requiredFields = [{ id: 'plate', name: 'Placa', critical: true }, { id: 'orderNum', name: 'N¬∫ Orden de Trabajo', critical: true }];
        let stop = false;
        requiredFields.forEach(f => {
            const el = document.getElementById(f.id);
            if (!el || !el.value.trim()) { showCustomAlert('Campo obligatorio', 'Falta: ' + f.name, [], 'error'); stop = true; }
        });
        if (stop) { if(btnPrint) btnPrint.removeAttribute('disabled'); return; }

        // --- PREPARAR IMPRESI√ìN ---
        
        // 1. Aplicar clases para impresi√≥n
        document.querySelectorAll('.check-item').forEach(item => {
            item.classList.remove('is-checked-print', 'is-pass-print', 'is-fail-print');
            const pass = item.querySelector('.check-pass');
            const fail = item.querySelector('.check-fail');
            const simple = item.querySelector('input[type="checkbox"]:not(.check-pass):not(.check-fail)');

            if (pass && pass.checked) {
                item.classList.add('is-checked-print', 'is-pass-print');
            } else if (fail && fail.checked) {
                item.classList.add('is-checked-print', 'is-fail-print');
            } else if (simple && simple.checked) {
                item.classList.add('is-checked-print', 'is-pass-print');
            }
        });

        // 2. Ocultar observaciones vac√≠as
        document.querySelectorAll('.obs-area').forEach(obsArea => {
            const textarea = obsArea.querySelector('textarea');
            if (textarea && textarea.value.trim() === '') obsArea.classList.add('empty-print');
        });

        // 3. Ocultar secciones vac√≠as
        document.querySelectorAll('.section').forEach(sec => {
            sec.classList.remove('empty-print');
            const hasChecked = sec.querySelectorAll('.is-checked-print').length > 0;
            const obsVal = sec.querySelector('textarea') ? sec.querySelector('textarea').value.trim() : "";
            if (!hasChecked && !obsVal) sec.classList.add('empty-print');
        });

        // L√≥gica de bloques Admin
        const ejecutadosSelect = document.getElementById('sys-ejecutados').value;
        const devolucion = document.getElementById('devolucion-block');
        const corregido = document.getElementById('corregido-block');
        if (ejecutadosSelect === 'SI') { 
            if(devolucion) devolucion.classList.add('ocultar-admin-print'); 
            if(corregido) corregido.classList.add('ocultar-admin-print'); 
        }

        addPrintDate();

        // --- SOLUCI√ìN PARA ANDROID ---
        // Definimos la funci√≥n de limpieza por separado
        const cleanupPrint = () => {
            if (btnPrint) btnPrint.removeAttribute('disabled');
            document.querySelectorAll('.check-item').forEach(i => i.classList.remove('is-checked-print', 'is-pass-print', 'is-fail-print'));
            document.querySelectorAll('.obs-area').forEach(i => i.classList.remove('empty-print'));
            document.querySelectorAll('.section').forEach(i => i.classList.remove('empty-print'));
            if(devolucion) devolucion.classList.remove('ocultar-admin-print');
            if(corregido) corregido.classList.remove('ocultar-admin-print');
            removePrintDate();
            
            // Removemos los listeners para que no se ejecuten m√∫ltiples veces
            window.removeEventListener('afterprint', cleanupPrint);
            window.removeEventListener('focus', cleanupPrint);
            document.removeEventListener('touchstart', cleanupPrint); 
        };

        // Peque√±o retardo para asegurar que el DOM se actualice antes de llamar a print
        setTimeout(() => {
            window.print();

            // EN LUGAR DE UN TIMEOUT FIJO, USAMOS EVENTOS:
            
            // 1. Intentar usar el evento est√°ndar (funciona en PC)
            window.addEventListener('afterprint', cleanupPrint);
            
            // 2. Para m√≥viles: Limpiar cuando el usuario toque la pantalla o regrese al foco
            // Esto mantiene el DOM modificado mientras el di√°logo de impresi√≥n est√© encima.
            window.addEventListener('focus', cleanupPrint); 
            
            // Fallback final: Si el usuario toca la pantalla (significa que ya cerr√≥ el di√°logo de impresi√≥n)
            setTimeout(() => {
                document.addEventListener('touchstart', cleanupPrint, { once: true });
                document.addEventListener('click', cleanupPrint, { once: true });
            }, 500);

        }, 500);
    }
    
    if (window.matchMedia) { const mql = window.matchMedia('print'); mql.addListener((m) => { if (m.matches) addPrintDate(); else removePrintDate(); }); }
    window.addEventListener('beforeprint', addPrintDate);
    window.addEventListener('afterprint', removePrintDate);

    function setupFocusListeners() {
        const sectionIds = ["sec-sistema", "sec-pintura", "sec-armado", "sec-pulido", "sec-tapiceria", "sec-control"];
        sectionIds.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (!section) return;
            section.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('focus', () => { section.classList.add('active-section'); });
                input.addEventListener('blur', () => { setTimeout(() => { if (!section.contains(document.activeElement)) section.classList.remove('active-section'); }, 100); });
            });
        });
    }

    function configurarInputOrden() {
        const input = document.getElementById('orderNum');
        if (!input) return;
        const formatearOrden = (mostrarToast) => {
            const originalValor = input.value;
            const prefijo = 'OT-'; 
            let parteNumerica = originalValor.startsWith(prefijo) ? originalValor.substring(prefijo.length) : originalValor;
            if (mostrarToast && /[^0-9]/.test(parteNumerica)) {
                showRichToast('Entrada no v√°lida', 'Solo se permiten d√≠gitos para el n√∫mero de Orden de Trabajo (m√°ximo 4).', 'warning', 3000);
            }
            let numerosLimpios = parteNumerica.replace(/[^0-9]/g, '');
            if (numerosLimpios.length > 4) numerosLimpios = numerosLimpios.slice(0, 4);
            input.value = prefijo + numerosLimpios;
        };
        input.addEventListener('input', function(e) { formatearOrden(true); saveForm(); });
        input.addEventListener('focus', function() { if (this.value === '' || this.value === 'OT-') this.value = 'OT-'; });
        input.addEventListener('keydown', function(e) { if ((e.key === 'Backspace' || e.key === 'Delete') && this.selectionStart <= 3) e.preventDefault(); });
        if (!input.value) input.value = 'OT-';
    }

    let signaturePad;
    function initSignaturePad() {
        const canvas = document.getElementById('signature-pad');
        if (!canvas) return;
        signaturePad = new SignaturePad(canvas, { minWidth: 1, maxWidth: 2.5, penColor: "black", backgroundColor: "white" });
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            let data = null;
            if(!signaturePad.isEmpty()) data = signaturePad.toDataURL();
            canvas.width = canvas.offsetWidth * ratio; canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            if(data) signaturePad.fromDataURL(data);
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();
        signaturePad.addEventListener("endStroke", () => { localStorage.setItem(STORAGE_KEY + "_sig", signaturePad.toDataURL()); });
    }
    
    window.borrarFirma = function() { if(signaturePad) { signaturePad.clear(); localStorage.removeItem(STORAGE_KEY + "_sig"); } };
    function loadSignature() { const savedSig = localStorage.getItem(STORAGE_KEY + "_sig"); if (savedSig && signaturePad) signaturePad.fromDataURL(savedSig); }

    function actualizarBloquesAdmin() {
        const valor = document.getElementById("sys-ejecutados").value;
        const devolucion = document.getElementById("devolucion-block");
        const corregido = document.getElementById("corregido-block");
        if (valor === "SI") { devolucion.style.display = "none"; corregido.style.display = "none"; } 
        else if (valor === "NO") { devolucion.style.display = "block"; corregido.style.display = "block"; } 
        else { devolucion.style.display = "none"; corregido.style.display = "none"; }
    }

    window.addEventListener("DOMContentLoaded", () => {
        initFlatpickr();
        loadForm();
        configurarInputOrden();
        initSignaturePad();
        loadSignature();
        actualizarBloquesAdmin();
        setupFocusListeners(); 
        updateAllSectionProgress();

        document.getElementById("sys-ejecutados").addEventListener("change", actualizarBloquesAdmin);
        document.querySelectorAll("input, select, textarea").forEach(el => {
            el.addEventListener("input", (e) => { saveForm(); updateAllSectionProgress(); });
            el.addEventListener("change", (e) => { saveForm(); updateAllSectionProgress(); });
        });
        document.querySelectorAll('.uppercase-input').forEach(input => {
            input.addEventListener('input', (e) => {
                const start = input.selectionStart; const end = input.selectionEnd;
                input.value = input.value.toUpperCase(); input.setSelectionRange(start, end);
            });
        });
    });
</script>

</body>
</html>
