<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Control de Calidad - GAS Paint & Detail</title>

    <link rel="icon" type="image/jpeg" href="assets/logo2.JPG">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        /* --- VARIABLES DE COLOR (Dark Mode para Pantalla) --- */
        :root {
            --primary-dark: #202D3F; 
            --container-bg: #2c3e50; 
            --primary-blue: #007bff; 
            --text-light: #ecf0f1; 
            --text-muted: #bdc3c7; 
            --success: #27ae60; 
            --border-dark: #495a6b; 
            --input-bg: #34495e; 
            --error: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary-dark);
            margin: 0;
            padding: 20px;
            color: var(--text-light);
            animation: fadePageIn 0.6s ease-out forwards;
        }
        .container {
            max-width: 850px;
            margin: 0 auto;
            background: var(--container-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.4);
        }

        /* --- LOGOS --- */
        .logo-container { text-align: center; margin-bottom: 20px; position: relative; }
        .logo-screen { max-width: 250px; height: auto; display: block; margin: 0 auto; }
        .logo-print { display: none !important; } /* Oculto en pantalla */
        #print-date-display { display: none; }

        h1 {
            text-align: center; color: var(--text-light); border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 10px; margin-top: 20px;
        }
        
        /* --- FORMULARIOS --- */
        .form-group { display: flex; flex-direction: column; margin-bottom: 10px; }
        .form-group label { font-weight: bold; margin-bottom: 5px; font-size: 0.9em; color: var(--text-muted); }

        input, select, textarea {
            padding: 10px; border: 1px solid var(--border-dark); border-radius: 4px; 
            font-size: 14px; background-color: var(--input-bg); color: var(--text-light);
            font-family: inherit; line-height: 1.5; width: 100%; box-sizing: border-box;
        }
        /* Touch targets */
        @media (max-width: 900px) {
            input, select, textarea { min-height: 44px; padding: 12px; font-size: 16px; }
        }
        
        .uppercase-input { text-transform: uppercase; } 
        textarea { resize: vertical; min-height: 60px; } 
        select option { background: var(--input-bg); color: var(--text-light); }

        /* Header Info (Grid Adaptable en Pantalla) */
        .header-info {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; margin-bottom: 20px; background: var(--input-bg);
            padding: 15px; border-radius: 5px; border: 1px solid var(--border-dark);
        }

        /* --- SECCIONES --- */
        .section {
            border: 1px solid var(--border-dark); border-radius: 8px; margin-bottom: 25px; 
            overflow: hidden; background: var(--input-bg); position: relative;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .section::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background: var(--border-dark); transition: background 0.3s ease;
        }
        .section:hover { box-shadow: 0 8px 24px rgba(0, 123, 255, 0.2); border-color: var(--primary-blue); transform: translateY(-2px); }
        .section:hover::before { background: var(--primary-blue); }
        .section.active-section { border-color: var(--primary-blue); box-shadow: 0 0 15px 3px rgba(0, 123, 255, 0.6); }
        .section.active-section::before { background: var(--success); }

        .section-header {
            background: linear-gradient(90deg, var(--primary-dark) 0%, rgba(0, 123, 255, 0.05) 100%);
            color: var(--text-light); padding: 16px 15px; font-weight: 700; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .section-header.completed { background-color: var(--success) !important; color: white !important; }
        .status-indicator { background: var(--border-dark); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; }
        .section-header.completed .status-indicator { background: white !important; color: var(--success) !important; }

        /* Barras de progreso */
        .progress-bar { position: fixed; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--primary-blue), var(--success)); z-index: 9999; }
        .section-progress-bar { height: 3px; background: var(--border-dark); margin-top: 0; }
        .section-progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary-blue), var(--success)); width: 0%; transition: width 0.3s ease; }

        /* --- CHECKLIST (Estilos Pantalla) --- */
        .checklist { padding: 10px 18px 18px 18px; }
        .check-item {
            display: flex; align-items: center; padding: 12px 0;
            border-bottom: 1px solid var(--border-dark); transition: 0.2s ease;
        }
        .check-item:last-child { border-bottom: none; }
        .check-item:hover { background: rgba(255, 255, 255, 0.05); }
        .check-item input[type="checkbox"] {
            width: 22px; height: 22px; border: 2px solid var(--border-dark); 
            border-radius: 6px; margin-right: 12px; cursor: pointer; flex-shrink: 0;
            appearance: none; -webkit-appearance: none; background-color: var(--input-bg);
            display: flex; align-items: center; justify-content: center;
        }
        .check-item input[type="checkbox"]:checked {
            background: var(--success); border-color: var(--success);
        }
        /* El check ‚úî de pantalla */
        .check-item input[type="checkbox"]:checked::after { content: "‚úî"; color: white; font-weight: bold; font-size: 14px; }
        .check-item label { cursor: pointer; line-height: 1.4; width: 100%; }

        /* --- ADMIN CLUSTERS --- */
        .admin-row { padding: 15px; border-bottom: 1px solid var(--border-dark); }
        .admin-question { font-weight: 600; margin-bottom: 10px; display: block; }
        .input-cluster { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        
        /* Bloques Condicionales */
        .highlight-box { padding: 10px; border-radius: 4px; margin-top: 10px; border: 1px solid; display: none; }
        #devolucion-block { background-color: #5d4037; border-color: #8d6e63; }
        #corregido-block { background-color: #004d40; border-color: #26a69a; }
        .sub-note { font-size: 0.85em; color: var(--text-light); margin-top: 5px; font-style: italic; }
        .error-text { color: var(--error); font-size: 0.85em; display: none; margin-top: 5px;}
        .error-text.visible { display: block; }
        .input-invalid { border-color: var(--error) !important; }

        /* --- TEXTAREAS DE OBS --- */
        .obs-area { padding: 15px; border-top: 1px dashed var(--border-dark); background-color: rgba(0,0,0,0.1); }

        /* --- CORRECCI√ìN VISUAL FECHAS/HORAS (MOBILE) --- */
        .flat-date, .flat-date + input {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23bdc3c7' viewBox='0 0 24 24'%3E%3Cpath d='M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10z'/%3E%3C/svg%3E") !important;
            background-repeat: no-repeat !important; background-position: right 10px center !important; background-size: 20px !important; padding-right: 35px !important;
        }
        .flat-time, .flat-time + input {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23bdc3c7' viewBox='0 0 24 24'%3E%3Cpath d='M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z'/%3E%3C/svg%3E") !important;
            background-repeat: no-repeat !important; background-position: right 10px center !important; background-size: 20px !important; padding-right: 35px !important;
        }
        ::placeholder { color: #bdc3c7 !important; opacity: 1 !important; font-weight: normal; }
        @media (max-width: 600px) {
            .input-cluster input.flat-date, .input-cluster input.flat-time { min-width: 130px !important; flex-grow: 1; }
        }

        /* --- BOTONES & FOOTER --- */
        .button-group { display: flex; gap: 10px; margin-top: 30px; }
        .btn-submit, .btn-clear { flex-grow: 1; padding: 15px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1.1em; }
        .btn-submit { background: linear-gradient(135deg, var(--primary-blue), #0056b3); }
        .btn-clear { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-submit[disabled] { opacity: 0.6; cursor: not-allowed; }
        
        .footer-info { text-align: center; margin-top: 40px; padding: 20px; border-top: 2px solid var(--border-dark); color: var(--text-muted); font-size: 0.85em; }
        .signature-box { display: none; }

        /* --- UI COMPONENTS (Toast/Modal) --- */
        #save-indicator { position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 8px 15px; border-radius: 5px; opacity: 0; transition: opacity 0.5s; z-index: 1000; font-weight: bold; }
        
        /* Modal Overlay */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 20000; }
        .confirm-dialog { background: var(--container-bg); padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; border: 1px solid var(--border-dark); }
        .cd-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .cd-actions button { padding: 10px 15px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold; }
        .btn-cancel { background: transparent; border: 1px solid var(--border-dark) !important; color: var(--text-light); }
        
        /* Toasts */
        .toast-container { position: fixed; right: 20px; bottom: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: rgba(0,0,0,0.9); color: white; padding: 12px 16px; border-radius: 8px; border-left: 5px solid; max-width: 350px; }
        .toast.error { border-color: var(--error); } .toast.info { border-color: var(--primary-blue); }

        /* ========================================= */
        /* ESTILOS BLINDADOS DE IMPRESI√ìN       */
        /* ========================================= */
        @media print {
            @page { margin: 1cm; size: auto; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

            body { background: white !important; color: black !important; font-family: Arial, sans-serif; font-size: 11pt; padding: 0; margin: 0; }
            .container { box-shadow: none; border: none; padding: 0; margin: 0; max-width: 100%; width: 100%; background: white !important; }
            
            /* Ocultar elementos de interfaz */
            .button-group, .print-hidden-icon, .footer-info, h1, #save-indicator, .toast-container, .logo-screen { display: none !important; }
            .section-index { display: none; }
            .section-progress-bar { display: none !important; }

            /* Encabezado */
            .logo-container { 
                border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 15px; 
                display: flex; align-items: center; justify-content: space-between;
            }
            .logo-print { display: block !important; max-width: 160px; height: auto; }
            .logo-container::after { 
                content: "REPORTE Control de Calidad"; 
                font-size: 16pt; font-weight: bold; color: black;
                margin-left: 15px; flex-grow: 1; text-align: right;
            }
            #print-date-display { 
                display: block !important; position: absolute; right: 0; top: -15px; font-size: 9pt; 
            }

            /* Info Header: FORZAR GRID DE 3 COLUMNAS */
            .header-info { 
                display: grid !important; 
                grid-template-columns: 1fr 1fr 1fr !important; /* Estricto 3 columnas */
                gap: 10px; border: 1px solid black; background: white !important; color: black !important; 
                margin-bottom: 15px; padding: 10px;
            }
            .header-info .form-group { margin-bottom: 0; }
            .header-info label { color: black !important; font-size: 10pt; }
            .header-info input { 
                border: 1px solid #ccc; background: white !important; color: black !important; 
                font-weight: bold; font-size: 11pt; padding: 5px; height: auto;
            }

            /* Secciones */
            .section { 
                border: 1px solid black !important; page-break-inside: avoid; margin-bottom: 10px; 
                background: white !important; box-shadow: none !important;
            }
            .section-header { 
                background: #e0e0e0 !important; color: black !important; border-bottom: 1px solid black; 
                padding: 8px 10px; font-size: 12pt;
            }
            .status-indicator { display: none; }

            /* Checklist: Resetear Flexbox para que parezca lista de papel */
            .checklist { padding: 5px 10px; }
            
            /* Ocultar items no marcados */
            .check-item { display: none !important; }
            
            /* Mostrar SOLO marcados y resetear estilo */
            .check-item.is-checked-print { 
                display: block !important; /* Bloque simple */
                border-bottom: 1px dotted #ccc; 
                padding: 4px 0; margin: 0;
            }

            /* --- CORRECCI√ìN CR√çTICA DE LA CASILLA VERDE --- */
            /* Forzar ocultamiento del input (la caja verde) */
            .check-item input,
            .check-item input[type="checkbox"] { 
                display: none !important; 
                width: 0 !important; 
                height: 0 !important; 
                opacity: 0 !important;
                position: absolute;
            }
            
            /* Simular el check con texto limpio */
            .check-item label { 
                color: black !important; font-weight: 500; font-size: 10pt; 
                display: block; width: 100%;
            }
            .check-item label::before { 
                content: "‚òë "; font-size: 12pt; margin-right: 5px; font-weight: bold; 
            }

            /* Admin y Obs */
            .admin-row { background: white !important; border-bottom: 1px solid #ccc; padding: 8px; }
            .admin-question { color: black !important; font-size: 10pt; }
            .obs-area { 
                border-top: 1px solid black; background: white !important; color: black; padding: 8px;
            }
            .obs-area textarea { border: 1px solid #999; color: black; font-size: 10pt; min-height: 40px; }
            
            /* Ocultar vac√≠os */
            .obs-area.empty-print, .section.empty-print { display: none !important; }

            /* Firma */
            .signature-box { 
                display: flex !important; justify-content: space-between; margin-top: 40px; margin-bottom: 20px;
                padding: 0 30px; page-break-inside: avoid; font-weight: bold; color: black; font-size: 12pt;
            }
            
            /* Inputs de fecha/admin en impresi√≥n */
            .input-cluster select, .input-cluster input { 
                border: none; border-bottom: 1px dotted black; padding: 0; margin-left: 5px; 
                font-weight: bold; background: transparent !important;
            }
            .sub-note { color: #333 !important; }
        }
    </style>
</head>
<body>

    <div id="save-indicator">üíæ Guardado</div>

    <div class="container">
        <div class="logo-container">
            <img src="assets/logo.png" class="logo-screen" alt="Logo" onerror="this.style.display='none'">
            <img src="assets/logo.jpeg" class="logo-print" alt="Logo Impresi√≥n">
            <div id="print-date-display"></div>
        </div>

        <h1>Control de Calidad - GAS Paint</h1>

        <div class="header-info">
            <div class="form-group">
                <label>N¬∫ Orden de Trabajo:</label>
                <input type="text" id="orderNum" class="uppercase-input" placeholder="Ej: OT-2025-001">
            </div>
            <div class="form-group">
                <label>Placa:</label>
                <input type="text" id="plate" class="uppercase-input" maxlength="9" placeholder="Ej: ABC-1234">
            </div>
            <div class="form-group">
                <label>Marca del Veh√≠culo:</label>
                <input type="text" id="brand" placeholder="Ej: Toyota"> 
            </div>
        </div>

        <div class="section" id="sec-sistema">
            <div class="section-header">
                <span><span class="print-hidden-icon">üìù</span> <span class="section-index">A.</span> ORDEN DE TRABAJO Y SISTEMA</span>
                <span class="status-indicator">PENDIENTE</span>
            </div>
            <div class="admin-row">
                <span class="admin-question">1. ¬øSe encuentra la Orden de Trabajo finalizada en el Sistema?</span>
                <div class="input-cluster">
                    <select id="sys-finalizada">
                        <option value="" selected disabled hidden>Seleccione...</option><option value="SI">S√ç</option><option value="NO">NO</option>
                    </select>
                    <input type="text" id="sys-finalizada-date" class="flat-date" placeholder="DD/MM/YYYY">
                    <input type="text" id="sys-finalizada-time" class="flat-time" placeholder="HH:MM">
                </div>
            </div>
            <div class="admin-row">
                <span class="admin-question">2.a. ¬øTodos los servicios en la Orden verificables, se ejecutaron?</span>
                <div class="input-cluster">
                    <select id="sys-ejecutados">
                        <option value="" selected disabled hidden>Seleccione...</option><option value="SI">S√ç</option><option value="NO">NO</option>
                    </select>
                    <input type="text" id="sys-ejecutados-date" class="flat-date" placeholder="DD/MM/YYYY">
                    <input type="text" id="sys-ejecutados-time" class="flat-time" placeholder="HH:MM">
                </div>
                <div id="devolucion-block" class="highlight-box">
                    <span class="sub-note">2.b. En caso negativo, devolver a Operaciones.</span>
                    <div class="input-cluster" style="margin-top:5px;">
                        <label>Devuelto:</label>
                        <input type="text" id="devuelto-date" class="flat-date" placeholder="DD/MM/YYYY">
                        <input type="text" id="devuelto-time" class="flat-time" placeholder="HH:MM">
                    </div>
                </div>
                <div id="corregido-block" class="highlight-box">
                    <span class="sub-note">3. Revisado y corregido.</span>
                    <div class="input-cluster" style="margin-top:5px;">
                        <label>Corregido:</label>
                        <input type="text" id="corregido-date" class="flat-date" placeholder="DD/MM/YYYY">
                        <input type="text" id="corregido-time" class="flat-time" placeholder="HH:MM">
                    </div>
                    <div id="corregido-error" class="error-text">La fecha de correcci√≥n no puede ser anterior a la de devoluci√≥n.</div>
                </div>
            </div>
            <div class="checklist">
                <div class="check-item" style="background-color: var(--input-bg); border-radius:4px; padding:10px;">
                    <input type="checkbox" id="admin-ok">
                    <label for="admin-ok"><strong>CONFIRMAR:</strong> La revisi√≥n administrativa est√° completa.</label>
                </div>
            </div>
            <div class="obs-area">
                <label class="form-group">Observaciones:</label>
                <textarea id="obs-sistema" placeholder="Detalles administrativos..."></textarea>
            </div>
        </div>

        <div class="section" id="sec-pintura" data-config-key="pintura">
            <div class="section-header">
                <span><span class="print-hidden-icon">üñåÔ∏è</span> <span class="section-index">B.</span> PINTURA</span>
                <span class="status-indicator">PENDIENTE</span>
            </div>
            <div class="section-progress-bar"><div class="section-progress-fill"></div></div>
            <div class="checklist"></div> <div class="obs-area">
                <label class="form-group">Observaciones Pintura:</label>
                <textarea id="obs-pintura" placeholder="Defectos encontrados..."></textarea>
            </div>
        </div>

        <div class="section" id="sec-armado" data-config-key="armado">
            <div class="section-header">
                <span><span class="print-hidden-icon">üî©</span> <span class="section-index">B.</span> ARMADO Y AJUSTE</span>
                <span class="status-indicator">PENDIENTE</span>
            </div>
            <div class="section-progress-bar"><div class="section-progress-fill"></div></div>
            <div class="checklist"></div>
            <div class="obs-area">
                <label class="form-group">Observaciones Armado:</label>
                <textarea id="obs-armado" placeholder="Detalles de ajuste..."></textarea>
            </div>
        </div>

        <div class="section" id="sec-pulido" data-config-key="pulido">
            <div class="section-header">
                <span><span class="print-hidden-icon">‚ú®</span> <span class="section-index">C.</span> PULIDO Y EXTERIOR</span>
                <span class="status-indicator">PENDIENTE</span>
            </div>
            <div class="section-progress-bar"><div class="section-progress-fill"></div></div>
            <div class="checklist"></div>
            <div class="obs-area">
                <label class="form-group">Observaciones Exterior:</label>
                <textarea id="obs-pulido" placeholder="Detalles de correcci√≥n..."></textarea>
            </div>
        </div>

        <div class="section" id="sec-tapiceria" data-config-key="tapiceria">
            <div class="section-header">
                <span><span class="print-hidden-icon">üßº</span> <span class="section-index">D.</span> TAPICER√çA E INTERIOR</span>
                <span class="status-indicator">PENDIENTE</span>
            </div>
            <div class="section-progress-bar"><div class="section-progress-fill"></div></div>
            <div class="checklist"></div>
            <div class="obs-area">
                <label class="form-group">Observaciones Interior:</label>
                <textarea id="obs-interior" placeholder="Detalles de tapicer√≠a..."></textarea>
            </div>
        </div>

        <div class="section" id="sec-control" data-config-key="control">
            <div class="section-header">
                <span><span class="print-hidden-icon">‚öôÔ∏è</span> <span class="section-index">E.</span> CONTROL MEC√ÅNICO</span>
                <span class="status-indicator">PENDIENTE</span>
            </div>
            <div class="section-progress-bar"><div class="section-progress-fill"></div></div>
            <div class="checklist"></div>
            <div class="obs-area">
                <label class="form-group">Observaciones Mec√°nicas:</label>
                <textarea id="obs-control" placeholder="Notas mec√°nicas..."></textarea>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-clear" onclick="limpiarFormulario()">üóëÔ∏è Limpiar</button>
            <button id="btn-print" class="btn-submit" onclick="generarReporte()">üñ®Ô∏è Finalizar e Imprimir</button>
        </div>
        
        <div class="signature-box">
            <div>Nombre: __________________________</div>
            <div>Firma: __________________________</div>
        </div>

        <div class="footer-info">Versi√≥n 2.0.2 (Fix Visual) - Control de Calidad GAS</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // --- 1. CONFIGURACI√ìN DIN√ÅMICA DE PREGUNTAS ---
        const CHECKLIST_CONFIG = {
            pintura: [
                {id: "p1", text: "La textura del transparente es la adecuada conforme con la originalidad"},
                {id: "p2", text: "Los bordes, filos y l√≠neas repasadas est√°n libres de excesos"},
                {id: "p3", text: "Las l√≠neas de las piezas repintadas son id√©nticas a las originales"},
                {id: "p4", text: "Superficies libres de defectos (rayas, opacamiento, manchas)"},
                {id: "p5", text: "Empaques externos libres de residuos de pintura/pulimento"},
                {id: "p6", text: "Si negativo: Revisar contra Recepci√≥n por da√±os preexistentes"},
                {id: "p7", text: "Correcci√≥n Total: verificar si servicios incompletos fueron corregidos"}
            ],
            armado: [
                {id: "a1", text: "Interior de piezas reparadas libre de suciedad"},
                {id: "a2", text: "Piezas m√≥viles abren/cierran con suavidad y sin golpes"},
                {id: "a3", text: "Piezas ajustan correctamente (sin desalineaciones)"},
                {id: "a4", text: "Niveles de aceite, frenos y refrigerante adecuados"},
                {id: "a5", text: "Luces y testigos funcionan correctamente"},
                {id: "a6", text: "Molduras, parrillas y empaques limpios y sin da√±os"},
                {id: "a7", text: "Vidrios sin da√±os derivados de la reparaci√≥n"},
                {id: "a8", text: "Exterior libre de suciedad de proceso (cinta, polvo)"}
            ],
            pulido: [
                {id: "pu1", text: "Sin rayas, manchas u opacamiento por pulido"},
                {id: "pu2", text: "Vidrios pulidos (sin manchas ni marcas de agua)"},
                {id: "pu3", text: "Partes negras acondicionadas"},
                {id: "pu4", text: "Manillas de puertas limpias (interior y exterior)"},
                {id: "pu5", text: "Torpedo y escobillas detallados correctamente"},
                {id: "pu6", text: "Bordes del veh√≠culo sin residuos (polish/cera)"},
                {id: "pu7", text: "Superficies externas sin residuos de pulimento"},
                {id: "pu8", text: "Cap√≥, guardabarros y superficies externas limpias"},
                {id: "pu9", text: "Superficies lavadas correctamente tras el proceso"},
                {id: "pu10", text: "Libre de rayas superficiales que debieron eliminarse"},
                {id: "pu11", text: "En caso negativo, corregir antes de la entrega"}
            ],
            tapiceria: [
                {id: "t1", text: "Aspirado de piso y alfombras detallado"},
                {id: "t2", text: "Tapicer√≠a aspirada y detallada correctamente"},
                {id: "t3", text: "Rejillas de ventilaci√≥n limpias y detalladas"},
                {id: "t4", text: "Dash limpio y detallado"},
                {id: "t5", text: "Guarda soles limpios y detallados"},
                {id: "t6", text: "Consola central limpia y detallada"},
                {id: "t7", text: "Guantera y compartimientos limpios"},
                {id: "t8", text: "Cielo (techo) detallado y limpio"},
                {id: "t9", text: "Asientos detallados y limpios"},
                {id: "t10", text: "Empaques externos limpios y detallados"},
                {id: "t11", text: "Empaques internos limpios y detallados"},
                {id: "t12", text: "Empaque del cap√≥ limpio y detallado"},
                {id: "t13", text: "Empaque de la cajuela limpio y detallado"},
                {id: "t14", text: "Pantallas y espejos limpios"},
                {id: "t15", text: "Pedales correctamente limpios y detallados"},
                {id: "t16", text: "Cajuela aspirada y limpia"},
                {id: "t17", text: "Habit√°culo/cajuela/batea limpio y detallado"}
            ],
            control: [
                {id: "m1", text: "Niveles de l√≠quidos adecuados"},
                {id: "m2", text: "Luces y testigos funcionando"},
                {id: "m3", text: "Veh√≠culo listo para entrega sin reportes pendientes"}
            ]
        };

        const STORAGE_KEY = "form-calidad-gas";

        // --- 2. RENDERIZADO DEL HTML ---
        function renderChecklists() {
            document.querySelectorAll('.section[data-config-key]').forEach(section => {
                const key = section.dataset.configKey;
                const items = CHECKLIST_CONFIG[key];
                const container = section.querySelector('.checklist');
                
                if (items && container) {
                    container.innerHTML = items.map(item => `
                        <div class="check-item">
                            <input type="checkbox" id="${item.id}">
                            <label for="${item.id}">${item.text}</label>
                        </div>
                    `).join('');
                }
            });
        }

        // --- 3. L√ìGICA DE NEGOCIO ---
        function initFlatpickr() {
            flatpickr(".flat-date", { dateFormat: "Y-m-d", altInput: true, altFormat: "d/m/Y", onChange: saveForm });
            flatpickr(".flat-time", { enableTime: true, noCalendar: true, dateFormat: "H:i", altInput: true, altFormat: "h:i K", onChange: saveForm });
        }

        function checkSection(sectionId) {
            const section = document.getElementById(sectionId);
            if(!section) return;
            const allChecks = Array.from(section.querySelectorAll('input[type="checkbox"]'));
            const contentChecks = allChecks.filter(c => !c.id.includes('admin-ok')); 
            
            const total = contentChecks.length;
            const checked = contentChecks.filter(c => c.checked).length;
            const percent = total === 0 ? 0 : (checked / total) * 100;

            const bar = section.querySelector('.section-progress-fill');
            if(bar) bar.style.width = percent + '%';

            let isComplete = false;
            if(sectionId === 'sec-sistema') {
                const adminOk = document.getElementById('admin-ok');
                isComplete = adminOk && adminOk.checked;
            } else {
                isComplete = (checked === total && total > 0);
            }

            const header = section.querySelector('.section-header');
            const indicator = section.querySelector('.status-indicator');
            if (isComplete) {
                header.classList.add('completed');
                indicator.textContent = "‚úî COMPLETADO";
            } else {
                header.classList.remove('completed');
                indicator.textContent = "PENDIENTE";
            }
        }

        function updateAllSections() {
            ["sec-sistema", "sec-pintura", "sec-armado", "sec-pulido", "sec-tapiceria", "sec-control"].forEach(checkSection);
            handleAdminLogic();
        }

        function handleAdminLogic() {
            const val = document.getElementById("sys-ejecutados").value;
            const dev = document.getElementById("devolucion-block");
            const corr = document.getElementById("corregido-block");
            
            if (val === "NO") {
                dev.style.display = "block";
                corr.style.display = "block";
            } else {
                dev.style.display = "none";
                corr.style.display = "none";
            }
            validateDates();
        }

        function validateDates() {
            const getD = (id) => document.getElementById(id).value;
            const devDate = getD("devuelto-date") + "T" + (getD("devuelto-time") || "00:00");
            const corDate = getD("corregido-date") + "T" + (getD("corregido-time") || "00:00");
            const err = document.getElementById("corregido-error");
            const btn = document.getElementById("btn-print");
            
            if (getD("devuelto-date") && getD("corregido-date")) {
                if (new Date(corDate) < new Date(devDate)) {
                    err.classList.add("visible");
                    btn.setAttribute("disabled", "true");
                    return false;
                }
            }
            err.classList.remove("visible");
            btn.removeAttribute("disabled");
            return true;
        }

        // --- 4. ALMACENAMIENTO (SAVE/LOAD) ---
        function saveForm() {
            const data = {};
            document.querySelectorAll("input, select, textarea").forEach(el => {
                if (!el.id) return;
                data[el.id] = el.type === "checkbox" ? el.checked : el.value;
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            
            const ind = document.getElementById('save-indicator');
            ind.style.opacity = 1;
            setTimeout(() => ind.style.opacity = 0, 800);
        }

        function loadForm() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            const data = JSON.parse(raw);
            for (let id in data) {
                const el = document.getElementById(id);
                if (el) {
                    if (el.type === "checkbox") el.checked = data[id];
                    else if (el._flatpickr) el._flatpickr.setDate(data[id]);
                    else el.value = data[id];
                }
            }
            updateAllSections();
        }

        function limpiarFormulario() {
            if(!confirm("¬øBorrar todo el formulario?")) return;
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }

        // --- 5. IMPRESI√ìN ---
        function generarReporte() {
            // Validar campos cr√≠ticos
            if(!document.getElementById('plate').value || !document.getElementById('orderNum').value) {
                alert("Faltan campos obligatorios (Placa u Orden).");
                return;
            }
            if(!validateDates()) return alert("Corrija las fechas antes de imprimir.");

            // Poner fecha
            const today = new Date().toLocaleDateString('es-ES');
            document.getElementById('print-date-display').textContent = today;

            // Preparar visualizaci√≥n impresi√≥n
            document.querySelectorAll('.check-item input:checked').forEach(input => {
                input.closest('.check-item').classList.add('is-checked-print');
            });

            // Ocultar secciones vac√≠as
            document.querySelectorAll('.section').forEach(sec => {
                const hasChecks = sec.querySelector('.is-checked-print');
                const hasObs = sec.querySelector('textarea').value.trim() !== "";
                // Sistema siempre visible si tiene datos, otros condicionales
                if(sec.id !== 'sec-sistema' && !hasChecks && !hasObs) {
                    sec.classList.add('empty-print');
                }
            });

            window.print();

            // Restaurar tras impresi√≥n
            setTimeout(() => {
                document.querySelectorAll('.is-checked-print').forEach(el => el.classList.remove('is-checked-print'));
                document.querySelectorAll('.empty-print').forEach(el => el.classList.remove('empty-print'));
            }, 500);
        }

        // --- 6. INICIALIZACI√ìN ---
        document.addEventListener("DOMContentLoaded", () => {
            renderChecklists(); 
            initFlatpickr();    
            loadForm();         
            
            document.body.addEventListener('change', (e) => {
                if (e.target.matches('input, select, textarea')) {
                    saveForm();
                    if (e.target.id === 'sys-ejecutados') handleAdminLogic();
                    if (e.target.closest('.input-cluster')) validateDates();
                    const section = e.target.closest('.section');
                    if (section) checkSection(section.id);
                }
            });

            document.querySelectorAll('.section').forEach(sec => {
                sec.addEventListener('focusin', () => sec.classList.add('active-section'));
                sec.addEventListener('focusout', () => sec.classList.remove('active-section'));
            });
        });
    </script>
</body>
</html>
