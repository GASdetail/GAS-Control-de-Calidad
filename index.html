<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Inspecci√≥n de Entrega - GAS Paint & Detail</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

    <style>
        /* --- VARIABLES DE COLOR (Ajustadas para Dark Mode en Pantalla) --- */
        :root {
            --primary-dark: #202D3F; 
            --container-bg: #2c3e50; 
            --primary-blue: #007bff; 
            --text-light: #ecf0f1; 
            --text-muted: #bdc3c7; 
            --success: #27ae60; 
            --border-dark: #495a6b; 
            --input-bg: #34495e; 
            --error: #e74c3c;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary-dark);
            margin: 0;
            padding: 20px;
            color: var(--text-light);
            animation: fadePageIn 0.6s ease-out forwards;
        }
        .container {
            max-width: 850px;
            margin: 0 auto;
            background: var(--container-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.4);
        }

        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo-container img {
            max-width: 250px;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--text-light);
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 10px;
            margin-top: 20px;
        }
        
        /* Estilos Generales y Secciones */
        .form-group { display: flex; flex-direction: column; margin-bottom: 10px; }
        .form-group label { font-weight: bold; margin-bottom: 5px; font-size: 0.9em; color: var(--text-muted); }

        input[type="text"], input[type="number"], select, input[type="date"], input[type="time"], textarea {
            padding: 10px; 
            border: 1px solid var(--border-dark);
            border-radius: 4px; 
            font-size: 14px;
            background-color: var(--input-bg);
            color: var(--text-light);
            font-family: inherit;
        }
        
        .uppercase-input { text-transform: uppercase; } 
        textarea { resize: vertical; min-height: 60px; } 
        select option { background: var(--input-bg); color: var(--text-light); }

        .header-info {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px;
            background: var(--input-bg);
            padding: 15px; 
            border-radius: 5px;
            border: 1px solid var(--border-dark);
        }
        .section {
            border: 1px solid var(--border-dark); 
            border-radius: 6px; 
            margin-bottom: 20px; 
            overflow: hidden;
            background: var(--input-bg);
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .section:hover { box-shadow: 0 0 15px rgba(0, 123, 255, 0.2); }
        
        /* Resaltado de la secci√≥n activa */
        .section.active-section {
            box-shadow: 0 0 15px 3px rgba(0, 123, 255, 0.6); 
            border-color: var(--primary-blue);
        }

        .section-header {
            background-color: var(--primary-dark);
            color: var(--text-light); 
            padding: 15px; 
            font-weight: bold; 
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            font-size: 1.1em;
            transition: background-color 0.3s;
        }
        .status-indicator {
            background: var(--border-dark);
            color: white; 
            padding: 5px 15px; 
            border-radius: 20px; 
            font-size: 0.8em;
            transition: background-color 0.3s;
        }
        .section-header.completed { 
            background-color: var(--success) !important; 
            color: white !important; 
            border-bottom: 1px solid var(--success); 
        }
        .section-header.completed .status-indicator { 
            background: white !important; 
            color: var(--success) !important; 
        }

        /* Estilos Administrativos */
        .admin-row { 
            padding: 15px; 
            border-bottom: 1px solid var(--border-dark); 
            background-color: var(--input-bg); 
        }
        .admin-question { 
            font-weight: 600; 
            color: var(--text-light); 
            margin-bottom: 10px; 
            display: block; 
        }
        .input-cluster { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .sub-note { font-size: 0.85em; color: var(--text-muted); margin-top: 5px; font-style: italic; }
        .highlight-box { 
            padding: 10px; 
            border-radius: 4px; 
            margin-top: 10px; 
            border: 1px solid; 
        }
        
        #devolucion-block { background-color: #5d4037; border-color: #8d6e63; color: var(--text-light); }
        #corregido-block { background-color: #004d40; border-color: #26a69a; color: var(--text-light); }
        #devolucion-block .sub-note, #corregido-block .sub-note { color: var(--text-light); }

        /* Error / validaci√≥n */
        .input-invalid { border-color: var(--error) !important; box-shadow: 0 0 8px rgba(231,76,60,0.25); }
        .error-text { color: var(--error); font-size: 0.85em; margin-top: 6px; display: none; }
        .error-text.visible { display: block; }

        /* --- REGLAS PARA FLATPICKR (Dark mode) --- */
        /* Asegurar que los altInputs / flatpickr inputs usen el tema oscuro y no se vuelvan blancos en hover/focus */
        .flatpickr-input,
        input.flatpickr-input,
        .flatpickr-alt-input {
            background-color: var(--input-bg) !important;
            color: var(--text-light) !important;
            border: 1px solid var(--border-dark) !important;
            padding: 10px !important;
            border-radius: 4px !important;
            box-sizing: border-box !important;
        }
        .flatpickr-input::placeholder,
        .flatpickr-alt-input::placeholder {
            color: var(--text-muted) !important;
            opacity: 0.9;
        }
        .flatpickr-input:hover,
        .flatpickr-input:focus,
        .flatpickr-alt-input:hover,
        .flatpickr-alt-input:focus {
            background-color: var(--input-bg) !important;
            color: var(--text-light) !important;
            outline: none !important;
            box-shadow: 0 0 0 4px rgba(0,123,255,0.06) !important;
        }

        /* Si flatpickr genera elementos con clase .flatpickr-time, aseguramos contraste en inputs internos */
        .flatpickr-time input {
            background-color: var(--input-bg) !important;
            color: var(--text-light) !important;
            border: 1px solid var(--border-dark) !important;
        }

        /* Si la librer√≠a a√±ade clases inline o estilos m√°s espec√≠ficos, forzamos con selector m√°s espec√≠fico */
        .input-cluster .flatpickr-input,
        .input-cluster input.flatpickr-input,
        .input-cluster .flatpickr-alt-input {
            background-color: var(--input-bg) !important;
            color: var(--text-light) !important;
        }
        /* Fin reglas flatpickr */

        /* √Årea de observaciones dentro de secciones */
        .obs-area {
            padding: 15px;
            border-top: 1px dashed var(--border-dark);
            background-color: rgba(0,0,0,0.1);
            display: flex; 
            flex-direction: column; 
        }
        .obs-area textarea {
            width: 100%;
            box-sizing: border-box;
        }


        /* CHECKLIST - Pantalla */
        .checklist { padding: 18px; }
        .check-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-dark); 
            transition: 0.25s ease;
        }
        .check-item:last-child { border-bottom: none; }
        .check-item:hover { transform: translateX(5px); background: rgba(255, 255, 255, 0.05); color: var(--text-light); }
        .check-item:hover label { color: var(--text-light); }


        .check-item input[type="checkbox"] {
            width: 22px; height: 22px; border: 2px solid var(--border-dark); border-radius: 5px; margin-right: 12px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.25s;
            background-color: var(--input-bg);
            appearance: none; -webkit-appearance: none;
        }
        .check-item input[type="checkbox"]:checked {
            background: var(--success); border-color: var(--success); box-shadow: 0 0 10px rgba(46,204,113,0.5); animation: pulseCheck .25s ease-in-out;
        }
        .check-item input[type="checkbox"]:checked::after { content: "‚úî"; color: white; font-size: 14px; font-weight: bold; }

        /* Botones */
        .button-group { display: flex; gap: 10px; margin-top: 30px; }
        .btn-submit, .btn-clear { flex-grow: 1; padding: 15px; border: none; border-radius: 5px; font-size: 1.2em; cursor: pointer; color: white; transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s; }
        .btn-submit { background-color: var(--primary-blue); }
        .btn-clear { background-color: #e74c3c; }
        .btn-submit:hover { background-color: #0056b3; transform: scale(1.02); box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4); }
        .btn-clear:hover { background-color: #c0392b; transform: scale(1.02); box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4); }

        .btn-submit[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* INDICADOR DE GUARDADO */
        #save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--success);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.5s ease;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        /* Estilos del Pie de P√°gina */
        .footer-info {
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid var(--border-dark);
            font-size: 0.85em;
            color: var(--text-muted);
        }

        /* ESTILOS DEL CANVAS DE FIRMA */
        #firma-inspector {
            /* Forzar fondo blanco y borde negro para la firma */
            border: 1px solid var(--border-dark); 
            border-radius: 4px; 
            background-color: white; /* Fondo blanco para dibujar */
            touch-action: none; /* Mejor experiencia en m√≥viles */
            /* Asegurar que el canvas sea responsivo en el layout */
            max-width: 100%; 
            height: auto;
        }

        /* REGLAS DE IMPRESI√ìN */
        @media print {
            @page { 
                margin: 1cm; 
                size: auto; 
            }
            
            /* Ocultar elementos no deseados */
            .print-hidden-icon, #save-indicator, .footer-info { 
                display: none !important; 
            }
            
            /* OCULTAR LETRA DE √çNDICE (A., B., C.) */
            .section-index {
                display: none !important;
            }
            
            /* FUERZA TODO A ALTO CONTRASTE */
            body, .container, .section, .header-info, input, select, textarea, label, span, div, p {
                background-color: #ffffff !important;
                color: #000000 !important; 
                box-shadow: none !important;
                text-shadow: none !important;
            }
            * { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }

            body {
                padding: 0;
                font-size: 11pt; 
                font-family: Arial, Helvetica, Helvetica, sans-serif; 
            }

            .container { max-width: 100%; width: 100%; margin: 0; padding: 0; border: none; }
            
            /* Encabezado y botones */
            .button-group, h1 { display: none !important; }

            .logo-container { text-align: left; margin-bottom: 15px; padding: 0 0 10px 0; border-bottom: 2px solid #000; display: flex; align-items: center; } 
            .logo-container img { max-width: 150px !important; height: auto !important; display: inline-block !important; margin-right: 15px !important; }
            .logo-container::after { content: "REPORTE DE INSPECCI√ìN DE CALIDAD - GAS PAINT"; font-size: 14pt; font-weight: bold; display: block; flex-grow: 1; text-align: left; }

            /* INPUTS */
            input[type="text"], input[type="date"], input[type="time"], input[type="number"], select, textarea { border: 1px solid #000 !important; border-radius: 0 !important; font-weight: bold; padding: 3px; background: white !important; color: black !important; font-size: 10pt; }
            .flatpickr-input, input.flatpickr-input, .flatpickr-alt-input, .flat-date, .flat-time { color: #000000 !important; background-color: #ffffff !important; border-color: #000000 !important; } /* FIX: Forzar color negro para fechas/horas */

            .section { border-color: #ccc; margin-bottom: 10px; }
            .section-header { background-color: #f0f0f0 !important; color: #000 !important; border-bottom: 1px solid #000; font-size: 10pt; padding: 5px 15px; }
            .section-header.completed { background-color: #d4edda !important; color: #155724 !important; border-bottom: 1px solid #155724; }
            .status-indicator { background: #ccc !important; color: #000 !important; font-size: 8pt; font-weight: normal; }

            /* Listas de verificaci√≥n */
            .checklist { padding: 5px 15px; }
            .check-item { display: none; padding: 5px 0; border-bottom: 1px dashed #ccc; font-size: 10pt; font-weight: normal; }
            .check-item.is-checked-print { display: flex !important; align-items: flex-start; } /* Mostrar solo los items marcados */
            .check-item:last-child { border-bottom: none; }
            .check-item input[type="checkbox"] { display: none !important; }
            .check-item label { color: #000 !important; display: inline; flex-grow: 1; }
            .check-item.is-checked-print label { font-weight: bold; }
            .check-item.is-checked-print label::before { font-family: Arial, sans-serif; font-size: 12pt; margin-right: 5px; font-weight: bold; content: "‚òë "; } /* S√≠mbolo de check */

            /* √Åreas de Observaciones */
            .obs-area { border-top: 1px solid #000; background: #fff !important; padding: 10px; }
            .obs-area label { font-size: 10pt; color: #000 !important; }
            textarea { border: 1px solid #000 !important; min-height: 40px; padding: 5px; font-size: 10pt; resize: none !important; }
            .obs-area.empty-print, .section.empty-print { display: none !important; }
            
            /* ‚úÖ NUEVO: FIRMA PARA IMPRESI√ìN */
            #firma-inspector-img {
                display: block !important; /* Mostrar el placeholder de la firma */
                max-width: 100%;
                height: 100px; /* Altura fija para la impresi√≥n */
                border: 1px solid #000;
                margin-top: 5px;
            }
            #firma-inspector, #sec-firmas .btn-clear {
                display: none !important; /* Ocultar el canvas de dibujo y el bot√≥n "Borrar" */
            }
            #sec-firmas .checklist {
                 background-color: #ffffff !important;
                 padding: 5px 15px !important;
            }
            #sec-firmas .form-group {
                border: none !important;
            }
        }
    </style>
</head>
<body>
    <div id="save-indicator">üíæ Guardado</div>
    <div class="container">
        <div class="logo-container">
            <img src="assets/logo.jpeg" alt="GAS Paint & Detail Logo" onerror="this.style.display='none'">
        </div>
        <h1>Inspecci√≥n de Entrega - GAS Paint</h1>

        <div class="header-info">
            <div class="form-group">
                <label for="ot-number">N¬∫ Orden de Trabajo</label>
                <input type="number" id="ot-number" placeholder="Ej: 12345" onchange="saveForm();">
            </div>
            <div class="form-group">
                <label for="placa">Placa</label>
                <input type="text" id="placa" class="uppercase-input" placeholder="Ej: ABC123" onchange="saveForm();">
            </div>
            <div class="form-group">
                <label for="modelo">Modelo</label>
                <input type="text" id="modelo" placeholder="Ej: Toyota Hilux" onchange="saveForm();">
            </div>
            <div class="form-group">
                <label for="fecha-inspeccion">Fecha de Inspecci√≥n</label>
                <input type="text" id="fecha-inspeccion" class="flat-date" placeholder="DD/MM/YYYY" onchange="saveForm();">
            </div>
            <div class="form-group">
                <label for="inspector">Inspector</label>
                <input type="text" id="inspector" placeholder="Nombre completo" onchange="saveForm();">
            </div>
        </div>

        <div class="section" id="sec-sistema">
            <div class="section-header">
                <span><span class="print-hidden-icon">üíª</span> <span class="section-index">A.</span> SISTEMA ADMINISTRATIVO</span>
                <span class="status-indicator">PENDIENTE</span>
            </div>

            <div class="admin-row">
                <span class="admin-question">1. ¬øSe encuentra la Orden de Trabajo finalizada en el Sistema?</span>
                <div class="input-cluster">
                    <select id="sys-finalizada" onchange="saveForm();">
                        <option value="" selected disabled hidden>Seleccione...</option>
                        <option value="SI">S√ç</option>
                        <option value="NO">NO</option>
                    </select>
                    <input type="text" id="finalizada-date" class="flat-date" title="Fecha Finalizada" placeholder="DD/MM/YYYY" aria-label="Fecha Finalizada">
                    <input type="text" id="finalizada-time" class="flat-time" title="Hora Finalizada" placeholder="HH:MM" aria-label="Hora Finalizada">
                </div>
            </div>

            <div class="admin-row">
                <span class="admin-question">2.a. ¬øTodos los servicios en la Orden verificables, se ejecutaron?</span>
                <div class="input-cluster">
                    <select id="sys-ejecutados" onchange="conditionalDisplay(); saveForm();">
                        <option value="" selected disabled hidden>Seleccione...</option>
                        <option value="SI">S√ç</option>
                        <option value="NO">NO</option>
                    </select>
                    <span id="ot-servicios" class="sub-note" style="margin-left: 15px;">2.b. (Si la respuesta es NO) Detalle a continuaci√≥n los servicios pendientes.</span>
                </div>
            </div>

            <div class="admin-row" id="devolucion-block" style="display: none;">
                <span class="admin-question">ORDEN DEVUELTA</span>
                <span class="sub-note">1. Devoluci√≥n al √°rea productiva para correcci√≥n de servicios faltantes.</span>
                <div class="input-cluster" style="margin-top:5px;">
                    <label>Devuelto:</label>
                    <input type="text" id="devuelto-date" class="flat-date" title="Fecha Devoluci√≥n" placeholder="DD/MM/YYYY" aria-label="Fecha de devoluci√≥n" onchange="validateCorrectionAfterReturn(); saveForm();">
                    <input type="text" id="devuelto-time" class="flat-time" title="Hora Devoluci√≥n" placeholder="HH:MM" aria-label="Hora de devoluci√≥n" onchange="validateCorrectionAfterReturn(); saveForm();">
                </div>
                
                <span id="devolucion-observacion" class="sub-note">2. Servicios a corregir:</span>
                <textarea id="obs-devolucion" placeholder="Especifique los servicios pendientes (ej: Pulir puerta trasera, Retoques en cap√≥)..." onchange="saveForm();"></textarea>
            </div>

            <div class="admin-row" id="corregido-block" style="display: none;">
                <span class="admin-question">ORDEN CORREGIDA</span>
                <span class="sub-note">3. Revisado por Operaciones y debidamente corregidos los servicios incompletos.</span>
                <div class="input-cluster" style="margin-top:5px;">
                    <label>Corregido:</label>
                    <input type="text" id="corregido-date" class="flat-date" title="Fecha Correcci√≥n" placeholder="DD/MM/YYYY" aria-label="Fecha de correcci√≥n" aria-describedby="corregido-error" onchange="validateCorrectionAfterReturn(); saveForm();">
                    <input type="text" id="corregido-time" class="flat-time" title="Hora Correcci√≥n" placeholder="HH:MM" aria-label="Hora de correcci√≥n" aria-describedby="corregido-error" onchange="validateCorrectionAfterReturn(); saveForm();">
                </div>
                <div id="corregido-error" class="error-text">La fecha/hora de correcci√≥n no puede ser anterior a la fecha/hora de devoluci√≥n.</div>
            </div>

            <div class="checklist">
                <div class="check-item" style="background-color: var(--input-bg); padding: 10px;">
                    <input type="checkbox" id="admin-ok" onchange="checkSection('sec-sistema'); saveForm();">
                    <label for="admin-ok"><strong>CONFIRMAR:</strong> La revisi√≥n administrativa est√° completa.</label>
                </div>
            </div>
            
            <div class="obs-area">
                <label class="form-group">Observaciones / Notas Admin:</label>
                <textarea id="obs-sistema" placeholder="Detalles administrativos adicionales..." onchange="saveForm();"></textarea>
            </div>
        </div>
        
        <div class="section" id="sec-pintura">
            <div class="section-header">
                <span><span class="print-hidden-icon">üñåÔ∏è</span> <span class="section-index">B.</span> PINTURA</span>
                <span class="status-indicator">PENDIENTE</span>
            </div>
            <div class="checklist">
                <div class="check-item"><input type="checkbox" id="p1" onchange="checkSection('sec-pintura'); saveForm();"><label for="p1">La textura del transparente es la adecuada conforme con la originalidad del veh√≠culo</label></div>
                <div class="check-item"><input type="checkbox" id="p2" onchange="checkSection('sec-pintura'); saveForm();"><label for="p2">Los bordes, filos y l√≠neas repasadas est√°n libres de excesos de transparente o pintura</label></div>
                <div class="check-item"><input type="checkbox" id="p3" onchange="checkSection('sec-pintura'); saveForm();"><label for="p3">Los cordones (uni√≥n de piezas) est√°n libres de exceso de sellador</label></div>
                <div class="check-item"><input type="checkbox" id="p4" onchange="checkSection('sec-pintura'); saveForm();"><label for="p4">El color se encuentra en tono y perlado (o metalizado) adecuado</label></div>
                <div class="check-item"><input type="checkbox" id="p5" onchange="checkSection('sec-pintura'); saveForm();"><label for="p5">El veh√≠culo no presenta manchas, rayas, residuos de pintura o escoria</label></div>
            </div>
            <div class="obs-area">
                <label class="form-group">Observaciones Pintura:</label>
                <textarea id="obs-pintura" placeholder="Detalles de pintura y acabados..." onchange="saveForm();"></textarea>
            </div>
        </div>
        
        <div class="section" id="sec-armado">
            <div class="section-header">
                <span><span class="print-hidden-icon">üî©</span> <span class="section-index">C.</span> ARMADO Y AJUSTE</span>
                <span class="status-indicator">PENDIENTE</span>
            </div>
            <div class="checklist">
                <div class="check-item"><input type="checkbox" id="a1" onchange="checkSection('sec-armado'); saveForm();"><label for="a1">Los ajustes de l√≠nea (luz y canto) son correctos</label></div>
                <div class="check-item"><input type="checkbox" id="a2" onchange="checkSection('sec-armado'); saveForm();"><label for="a2">Las piezas no reparadas est√°n libres de cualquier da√±o</label></div>
                <div class="check-item"><input type="checkbox" id="a3" onchange="checkSection('sec-armado'); saveForm();"><label for="a3">El funcionamiento de puertas, cap√≥ y cajuela es correcto</label></div>
                <div class="check-item"><input type="checkbox" id="a4" onchange="checkSection('sec-armado'); saveForm();"><label for="a4">Los focos, l√°mparas y dem√°s partes el√©ctricas funcionan correctamente</label></div>
                <div class="check-item"><input type="checkbox" id="a5" onchange="checkSection('sec-armado'); saveForm();"><label for="a5">Los testigos (luces del tablero) funcionan correctamente</label></div>
                <div class="check-item"><input type="checkbox" id="a6" onchange="checkSection('sec-armado'); saveForm();"><label for="a6">Las molduras, parrillas, empaques, escobillas u otras piezas est√°n limpias y sin da√±os</label></div>
                <div class="check-item"><input type="checkbox" id="a7" onchange="checkSection('sec-armado'); saveForm();"><label for="a7">Los vidrios no presentan da√±os derivados del proceso de reparaci√≥n</label></div>
                <div class="check-item"><input type="checkbox" id="a8" onchange="checkSection('sec-armado'); saveForm();"><label for="a8">El exterior del auto est√° libre de suciedad producida por el proceso de reparaci√≥n (polvo, cinta, residuos)</label></div>
            </div>
            <div class="obs-area">
                <label class="form-group">Observaciones Armado/Ajuste:</label>
                <textarea id="obs-armado" placeholder="Detalles de ajuste y piezas..." onchange="saveForm();"></textarea>
            </div>
        </div>
        
        <div class="section" id="sec-pulido">
            <div class="section-header">
                <span><span class="print-hidden-icon">‚ú®</span> <span class="section-index">D.</span> PULIDO Y EXTERIOR</span>
                <span class="status-indicator">PENDIENTE</span>
            </div>
            <div class="checklist">
                <div class="check-item"><input type="checkbox" id="pu1" onchange="checkSection('sec-pulido'); saveForm();"><label for="pu1">Sin rayas, manchas u opacamiento por pulido</label></div>
                <div class="check-item"><input type="checkbox" id="pu2" onchange="checkSection('sec-pulido'); saveForm();"><label for="pu2">Vidrios pulidos (sin manchas ni marcas de agua)</label></div>
                <div class="check-item"><input type="checkbox" id="pu3" onchange="checkSection('sec-pulido'); saveForm();"><label for="pu3">Partes negras acondicionadas</label></div>
                <div class="check-item"><input type="checkbox" id="pu4" onchange="checkSection('sec-pulido'); saveForm();"><label for="pu4">Manillas sin restos de pulimento</label></div>
                <div class="check-item"><input type="checkbox" id="pu5" onchange="checkSection('sec-pulido'); saveForm();"><label for="pu5">Rines y llantas limpios, sin restos de pulimento o pintura</label></div>
            </div>
            <div class="obs-area">
                <label class="form-group">Observaciones Pulido/Exterior:</label>
                <textarea id="obs-pulido" placeholder="Detalles de pulido y exterior..." onchange="saveForm();"></textarea>
            </div>
        </div>

        <div class="section" id="sec-tapiceria">
            <div class="section-header">
                <span><span class="print-hidden-icon">üßº</span> <span class="section-index">E.</span> TAPICER√çA Y LAVADO</span>
                <span class="status-indicator">PENDIENTE</span>
            </div>
            <div class="checklist">
                <div class="check-item"><input type="checkbox" id="t1" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t1">Limpieza del veh√≠culo completa</label></div>
                <div class="check-item"><input type="checkbox" id="t2" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t2">Alfombras limpias y detalladas</label></div>
                <div class="check-item"><input type="checkbox" id="t3" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t3">√Årea de piso y pedales limpia</label></div>
                <div class="check-item"><input type="checkbox" id="t4" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t4">Panel de instrumentos detallado y limpio</label></div>
                <div class="check-item"><input type="checkbox" id="t5" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t5">Puertas detalladas y limpias</label></div>
                <div class="check-item"><input type="checkbox" id="t6" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t6">Techo limpio y detallado</label></div>
                <div class="check-item"><input type="checkbox" id="t7" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t7">Cajuela limpia y detallada</label></div>
                <div class="check-item"><input type="checkbox" id="t8" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t8">Motor limpio y detallado</label></div>
                <div class="check-item"><input type="checkbox" id="t9" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t9">Asientos detallados y limpios</label></div>
                <div class="check-item"><input type="checkbox" id="t10" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t10">Empaques externos limpios y detallados</label></div>
                <div class="check-item"><input type="checkbox" id="t11" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t11">Empaques internos limpios y detallados</label></div>
                <div class="check-item"><input type="checkbox" id="t12" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t12">Empaque del cap√≥ limpio y detallado</label></div>
                <div class="check-item"><input type="checkbox" id="t13" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t13">Empaque de la cajuela limpio y detallado</label></div>
                <div class="check-item"><input type="checkbox" id="t14" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t14">Pantallas y espejos limpios</label></div>
                <div class="check-item"><input type="checkbox" id="t15" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t15">Pedales correctamente limpios y detallados</label></div>
                <div class="check-item"><input type="checkbox" id="t16" onchange="checkSection('sec-tapiceria'); saveForm();"><label for="t16">Limpieza y pulido de vidrios laterales, trasero y delantero</label></div>
            </div>
            <div class="obs-area">
                <label class="form-group">Observaciones Tapicer√≠a/Lavado:</label>
                <textarea id="obs-tapiceria" placeholder="Detalles de tapicer√≠a y limpieza..." onchange="saveForm();"></textarea>
            </div>
        </div>

        <div class="section" id="sec-firmas">
            <div class="section-header">
                <span><span class="print-hidden-icon">‚úçÔ∏è</span> <span class="section-index">F.</span> FIRMAS DE CONFORMIDAD</span>
            </div>
            <div class="checklist" style="background-color: var(--container-bg); padding: 20px;">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="firma-inspector" style="color: var(--text-light); font-size: 1.1em;">Firma del Inspector de Calidad:</label>
                    <canvas id="firma-inspector" width="400" height="150"></canvas>
                    <button type="button" class="btn-clear" onclick="clearSignature('inspector-sig');" style="width: 100px; padding: 5px; margin-top: 5px; font-size: 0.9em;">Borrar Firma</button>
                    <input type="hidden" id="inspector-sig" value=""> 
                    <img id="firma-inspector-img" style="display: none;" alt="Firma del Inspector">
                </div>
            </div>
        </div>


        <div class="button-group">
            <button type="button" class="btn-submit" onclick="validarFormulario()">IMPRIMIR / FINALIZAR</button>
            <button type="button" class="btn-clear" onclick="limpiarFormulario()">LIMPIAR</button>
        </div>
        
        <div class="footer-info">
            <p>Formulario de Inspecci√≥n de Entrega - GAS Paint & Detail</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script> 
    
    <script>
        const STORAGE_KEY = "gas_qc_form_data";
        const SAVE_INDICATOR_TIMEOUT = 1000;
        let saveTimeout;
        
        // ‚úÖ NUEVO: Variable global para el objeto SignaturePad
        let inspectorSignaturePad;
        
        // Debounce para guardar el formulario autom√°ticamente
        function debouncedSaveForm() {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            saveTimeout = setTimeout(() => {
                saveForm();
            }, 300); // Espera 300ms despu√©s de la √∫ltima entrada
        }

        // ==================================================
        // ‚úÖ NUEVO: L√ìGICA DE FIRMA (Signature Pad)
        // ==================================================
        function initSignaturePad() {
            const canvas = document.getElementById('firma-inspector');
            if (!canvas) return;

            // Inicializar el pad
            inspectorSignaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)', // Fondo blanco forzado
                penColor: 'rgb(0, 0, 0)', // Pluma negra
                throttle: 16, // Mejora el rendimiento
                minWidth: 1,
                maxWidth: 3
            });

            // Hacer que el canvas sea responsivo
            resizeCanvas(); 
            window.addEventListener('resize', resizeCanvas);
            
            // Auto-guardar la firma cuando se detiene el dibujo
            inspectorSignaturePad.addEventListener("endStroke", () => {
                debouncedSaveForm();
            }, { once: false });
        }

        function resizeCanvas() {
            const canvas = document.getElementById('firma-inspector');
            if (!canvas) return;

            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            
            // Obtener el ancho real del contenedor
            const displayWidth = canvas.parentElement.clientWidth;
            
            // Multiplicar por el ratio para la calidad
            canvas.width = displayWidth * ratio;
            canvas.height = 150 * ratio; // Altura fija en p√≠xeles de pantalla * ratio
            canvas.style.width = displayWidth + "px";
            canvas.style.height = "150px"; 

            // Si ya existe la firma, re-dibujarla despu√©s de redimensionar
            const dataUrl = document.getElementById('inspector-sig').value;
            if (!inspectorSignaturePad.isEmpty() || dataUrl) {
                // Si hay una firma cargada, re-dib√∫jala. Si no, SignaturePad lo manejar√°.
                if (dataUrl) {
                    inspectorSignaturePad.fromDataURL(dataUrl);
                }
            } else {
                 inspectorSignaturePad.clear(); // Limpiar el canvas si estaba vac√≠o
            }
            // Importante: re-escalar la pluma despu√©s del redimensionamiento
            inspectorSignaturePad.clear();
        }
        
        function clearSignature(id) {
            const canvas = document.getElementById(id.replace('-sig', ''));
            const input = document.getElementById(id);

            if (id === 'inspector-sig' && inspectorSignaturePad) {
                inspectorSignaturePad.clear();
            }
            input.value = "";
            saveForm();
        }
        // ==================================================
        // FIN L√ìGICA DE FIRMA
        // ==================================================


        // --- L√ìGICA DE GUARDADO ---
        function showSaveIndicator() {
            const indicator = document.getElementById("save-indicator");
            indicator.style.opacity = 1;
            setTimeout(() => {
                indicator.style.opacity = 0;
            }, SAVE_INDICATOR_TIMEOUT);
        }

        function saveForm() {
            const data = {};
            // Recorre todos los campos y guarda su valor
            document.querySelectorAll("input, select, textarea").forEach(el => {
                if (el.type === "checkbox") {
                    data[el.id] = el.checked;
                } else if (el.id) {
                    data[el.id] = el.value;
                }
            });

            // ‚úÖ NUEVO: Guardar la firma del inspector si existe
            if (inspectorSignaturePad && !inspectorSignaturePad.isEmpty()) {
                const signatureData = inspectorSignaturePad.toDataURL("image/png");
                document.getElementById('inspector-sig').value = signatureData;
                data['inspector-sig'] = signatureData;
                document.getElementById('firma-inspector-img').src = signatureData; // Sincronizar para impresi√≥n
            } else {
                data['inspector-sig'] = "";
                document.getElementById('firma-inspector-img').src = "";
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            showSaveIndicator();
            checkAllSections(); // Recalcula estados despu√©s de guardar
        }

        function loadForm() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;

            const data = JSON.parse(raw);

            for (let id in data) {
                const el = document.getElementById(id);
                if (!el) continue;

                if (el.type === "checkbox") {
                    el.checked = data[id];
                } else if (el.type === "hidden" && id === "inspector-sig") {
                     // ‚úÖ NUEVO: Cargar dato en el input oculto
                     el.value = data[id];
                } else {
                    el.value = data[id];
                }
            }

            // Sincronizar los valores con Flatpickr (despu√©s de cargar)
            syncFlatpickrValues();
            
            // ‚úÖ NUEVO: Cargar firma al canvas (despu√©s de cargar los datos)
            if (inspectorSignaturePad) {
                const signatureData = document.getElementById('inspector-sig').value;
                const imgEl = document.getElementById('firma-inspector-img');

                if (signatureData) {
                    // Cargar al pad. El pad redimensionado ya se ha inicializado.
                    // Primero, clear para asegurar que la re-carga Base64 sea la primera cosa dibujada.
                    inspectorSignaturePad.clear(); 
                    inspectorSignaturePad.fromDataURL(signatureData);
                    imgEl.src = signatureData;
                } else {
                    inspectorSignaturePad.clear();
                    imgEl.src = "";
                }
            }


            // Actualizar estados y visualizaci√≥n condicional
            conditionalDisplay();
            validateCorrectionAfterReturn();
            checkAllSections();
        }

        function limpiarFormulario() {
            if (confirm("¬øEst√° seguro que desea limpiar TODO el formulario? Esta acci√≥n no se puede deshacer.")) {
                localStorage.removeItem(STORAGE_KEY);
                // Resetear los campos a sus valores iniciales
                document.querySelectorAll("input, select, textarea").forEach(el => {
                    if (el.type === "checkbox") {
                        el.checked = false;
                    } else if (el.tagName === 'SELECT') {
                        el.selectedIndex = 0; // Seleccionar la primera opci√≥n (Seleccione...)
                    } else {
                        el.value = "";
                    }
                });

                // Limpiar Flatpickr
                syncFlatpickrValues(true); 

                // ‚úÖ NUEVO: Limpiar firma
                if (inspectorSignaturePad) {
                    inspectorSignaturePad.clear();
                    document.getElementById('inspector-sig').value = "";
                }

                // Resetear estados visuales
                conditionalDisplay();
                validateCorrectionAfterReturn();
                checkAllSections(); 
                alert("Formulario limpio.");
            }
        }

        // --- L√ìGICA DE VALIDACI√ìN Y VISUALIZACI√ìN ---
        function conditionalDisplay() {
            const executed = document.getElementById('sys-ejecutados').value;
            const devolutionBlock = document.getElementById('devolucion-block');
            const correctionBlock = document.getElementById('corregido-block');
            const devueltoDate = document.getElementById('devuelto-date').value.trim();

            if (executed === 'NO') {
                devolucionBlock.style.display = 'block';
                if (devueltoDate) {
                    correctionBlock.style.display = 'block';
                } else {
                    correctionBlock.style.display = 'none';
                }
            } else {
                devolucionBlock.style.display = 'none';
                correctionBlock.style.display = 'none';
            }
            // Vuelve a validar para actualizar errores visuales
            validateCorrectionAfterReturn();
        }

        function validateCorrectionAfterReturn() {
            const correctionError = document.getElementById('corregido-error');
            const correctedDateEl = document.getElementById('corregido-date');
            const correctedTimeEl = document.getElementById('corregido-time');
            const devueltoDateEl = document.getElementById('devuelto-date');
            const devueltoTimeEl = document.getElementById('devuelto-time');
            
            // Ocultar error si el bloque no est√° visible
            if (document.getElementById('corregido-block').style.display === 'none') {
                 correctionError.classList.remove('visible');
                 correctedDateEl.classList.remove('input-invalid');
                 correctedTimeEl.classList.remove('input-invalid');
                 return;
            }

            const dtDevuelto = getDateTimeFromInputs('devuelto-date', 'devuelto-time');
            const dtCorregido = getDateTimeFromInputs('corregido-date', 'corregido-time');

            // 1. Validar que la correcci√≥n no sea anterior a la devoluci√≥n
            if (dtCorregido && dtDevuelto && dtCorregido < dtDevuelto) {
                correctionError.classList.add('visible');
                correctedDateEl.classList.add('input-invalid');
                correctedTimeEl.classList.add('input-invalid');
                return false;
            } 
            
            // 2. Validar que si hay correcci√≥n, la devoluci√≥n tenga fecha (deber√≠a ser cubierta por conditionalDisplay, pero como backup)
            if (dtCorregido && !dtDevuelto) {
                correctionError.innerText = "Debe registrar la fecha/hora de devoluci√≥n antes de la correcci√≥n.";
                correctionError.classList.add('visible');
                devueltoDateEl.classList.add('input-invalid');
                devueltoTimeEl.classList.add('input-invalid');
                correctedDateEl.classList.remove('input-invalid');
                correctedTimeEl.classList.remove('input-invalid');
                return false;
            }

            // Si pasa todas las validaciones
            correctionError.classList.remove('visible');
            correctedDateEl.classList.remove('input-invalid');
            correctedTimeEl.classList.remove('input-invalid');
            devueltoDateEl.classList.remove('input-invalid');
            devueltoTimeEl.classList.remove('input-invalid');
            return true;
        }

        // --- L√ìGICA DE ESTADO DE SECCIONES ---
        function checkSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;

            const checkboxes = section.querySelectorAll('.checklist input[type="checkbox"]');
            const total = checkboxes.length;
            let checkedCount = 0;

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    checkedCount++;
                    // Agregar clase para impresi√≥n (si est√° marcado)
                    cb.closest('.check-item').classList.add('is-checked-print');
                } else {
                    // Quitar clase para impresi√≥n (si no est√° marcado)
                    cb.closest('.check-item').classList.remove('is-checked-print');
                }
            });

            const header = section.querySelector('.section-header');
            const indicator = section.querySelector('.status-indicator');

            if (total > 0 && checkedCount === total) {
                header.classList.add('completed');
                indicator.textContent = 'COMPLETO';
                section.classList.remove('active-section');
            } else if (checkedCount > 0) {
                header.classList.remove('completed');
                indicator.textContent = 'EN PROGRESO';
                section.classList.add('active-section');
            } else {
                header.classList.remove('completed');
                indicator.textContent = 'PENDIENTE';
                section.classList.remove('active-section');
            }
        }
        
        function checkAllSections() {
            ["sec-sistema", "sec-pintura", "sec-armado", "sec-pulido", "sec-tapiceria"].forEach(checkSection);
            prepareForPrint(); // Prepara el documento para la impresi√≥n
        }

        // --- L√ìGICA DE IMPRESI√ìN ---
        function prepareForPrint() {
            // 1. Marcar items seleccionados para impresi√≥n (esto se hace en checkSection)
            
            // 2. Ocultar √°rea de observaciones si est√° vac√≠a
            document.querySelectorAll('.obs-area').forEach(obsArea => {
                const textarea = obsArea.querySelector('textarea');
                if (textarea && textarea.value.trim() === '') {
                    obsArea.classList.add('empty-print');
                } else {
                    obsArea.classList.remove('empty-print');
                }
            });

            // 3. Ocultar secciones enteras si no tienen items marcados Y no tienen observaciones
            const sectionsToEvaluate = ["sec-pintura","sec-armado","sec-pulido","sec-tapiceria"];
            sectionsToEvaluate.forEach(secId => {
                const sec = document.getElementById(secId);
                if (!sec) return;
                
                const checkboxes = Array.from(sec.querySelectorAll('input[type="checkbox"]')).filter(cb => cb.checked).length > 0;
                const hasObs = !sec.querySelector('.obs-area').classList.contains('empty-print');

                if (!checkboxes && !hasObs) {
                    sec.classList.add('empty-print');
                } else {
                    sec.classList.remove('empty-print');
                }
            });
            
            // 4. Sincronizar el contenido del canvas con la imagen de impresi√≥n
             const sigInput = document.getElementById('inspector-sig');
             const sigImg = document.getElementById('firma-inspector-img');
             if (sigInput.value && sigImg) {
                 sigImg.src = sigInput.value;
             } else if (sigImg) {
                 sigImg.src = "";
             }
        }
        
        function validarFormulario() {
            if (!validateCorrectionAfterReturn()) {
                alert("ERROR: La fecha/hora de correcci√≥n no puede ser anterior a la de devoluci√≥n. Por favor, corrija el error en la Secci√≥n A.");
                return;
            }
            // Podr√≠as agregar m√°s validaciones aqu√≠ (ej: OT, Placa, Inspector no vac√≠os)

            prepareForPrint(); // Asegura la √∫ltima preparaci√≥n
            window.print();
        }

        // --- L√ìGICA DE FLATPICKR Y FECHAS ---
        let datePickers = [];
        let timePickers = [];
        
        function initFlatpickr() {
            // Establecer idioma espa√±ol por defecto
            flatpickr.setDefaults({ locale: 'es' });

            // Date Pickers: Formato YYYY-MM-DD para guardar, DD/MM/YYYY para mostrar.
            datePickers = Array.from(document.querySelectorAll(".flat-date")).map(el => flatpickr(el, {
                dateFormat: "Y-m-d", // valor real guardado en el input (ej: 2023-11-25)
                altInput: true,
                altFormat: "d/m/Y", // formato mostrado al usuario (ej: 25/11/2023)
                allowInput: true,
                onChange: function(selectedDates, dateStr, instance) {
                    debouncedSaveForm(); 
                    validateCorrectionAfterReturn();
                }
            }));
            
            // Time Pickers: Formato H:i (24h)
            timePickers = Array.from(document.querySelectorAll(".flat-time")).map(el => flatpickr(el, {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i", // valor real guardado en el input
                altInput: true,
                altFormat: "H:i",
                time_24hr: true,
                allowInput: true,
                clickOpens: true,
                onChange: function(selectedDates, dateStr, instance) {
                    debouncedSaveForm(); 
                    validateCorrectionAfterReturn();
                }
            }));
        }

        // Sincroniza los valores cargados desde localStorage con los objetos Flatpickr
        function syncFlatpickrValues(clear = false) {
             // 1. Sincronizar fechas
            if (datePickers && datePickers.length) {
                datePickers.forEach(inst => {
                    try {
                        if (clear || (inst.input && inst.input.value)) {
                            // inst.setDate acepta el valor real (Y-m-d)
                            inst.setDate(clear ? null : inst.input.value, false, "Y-m-d");
                        }
                    } catch (e) { /* ignore invalid dates */ }
                });
            }
            // 2. Sincronizar horas
            if (timePickers && timePickers.length) {
                timePickers.forEach(inst => {
                    try {
                        if (clear || (inst.input && inst.input.value)) {
                            // inst.setDate acepta el valor real (H:i)
                            inst.setDate(clear ? null : inst.input.value, false, "H:i");
                        }
                    } catch (e) { /* ignore invalid times */ }
                });
            }
        }

        // Helper: devuelve un objeto Date combinado desde inputs de fecha (Y-m-d) y hora (H:i).
        function getDateTimeFromInputs(dateId, timeId) {
            const dateEl = document.getElementById(dateId);
            if (!dateEl || !dateEl.value) return null; // fecha obligatoria para construir

            const timeEl = document.getElementById(timeId);
            const dateStr = dateEl.value; // YYYY-MM-DD (flatpickr dateFormat)
            const timeStr = (timeEl && timeEl.value) ? timeEl.value : "00:00"; // HH:MM
            
            // Construir ISO string: YYYY-MM-DDTHH:MM:00
            const iso = dateStr + "T" + timeStr + ":00";
            const dt = new Date(iso);
            
            if (isNaN(dt.getTime())) return null;
            return dt;
        }


        // üëâ Inicializaci√≥n: Al cargar la p√°gina
        window.addEventListener("DOMContentLoaded", () => {
            // 1) Inicializa flatpickr en los inputs (antes de cargar valores)
            initFlatpickr();
            
            // ‚úÖ NUEVO: Inicializar Signature Pad
            initSignaturePad();

            // 2) Carga valores guardados en localStorage y sincroniza con los pickers
            loadForm();

            // 3) Resto de listeners y comportamiento
            // Usar 'debouncedSaveForm' en lugar de 'saveForm' para reducir escrituras en localStorage
            document.querySelectorAll("input:not([type='checkbox']), select, textarea").forEach(el => {
                el.addEventListener("input", debouncedSaveForm);
                el.addEventListener("change", debouncedSaveForm);
            });
            
            // Checkboxes llaman a saveForm directamente (para actualizar el estado de la secci√≥n inmediatamente)
            document.querySelectorAll("input[type='checkbox']").forEach(el => {
                // Reemplaza el onchange en el HTML para usar debouncedSaveForm
                el.onchange = () => { checkSection(el.closest('.section').id); debouncedSaveForm(); };
            });

            // Los campos con validaci√≥n espec√≠fica tambi√©n llaman a la validaci√≥n en blur
            ["devuelto-date","devuelto-time","corregido-date","corregido-time"].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener("blur", validateCorrectionAfterReturn);
                }
            });

            // Forzar may√∫sculas en campos espec√≠ficos
            document.querySelectorAll('.uppercase-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const start = input.selectionStart;
                    const end = input.selectionEnd;
                    input.value = input.value.toUpperCase();
                    input.setSelectionRange(start, end);
                });
            });
            
            // Listener de cambio para el select de Ejecutados para visualizaci√≥n condicional
             document.getElementById('sys-ejecutados').onchange = () => { 
                conditionalDisplay(); 
                debouncedSaveForm(); 
            };
        });
    </script>
</body>
</html>
